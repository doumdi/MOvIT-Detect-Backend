[{"id":"785b00cb.55902","type":"tab","label":"Tilt result endpoint","disabled":false,"info":""},{"id":"70286646.4b1c9","type":"tab","label":"Pressure result endpoint","disabled":false,"info":""},{"id":"d8422fcd.8b4f88","type":"tab","label":"Data Reception","disabled":false,"info":""},{"id":"62e9dd9c.3ec8b4","type":"tab","label":"Login Endpoint","disabled":false,"info":""},{"id":"28ede86e.b0dc6","type":"tab","label":"Configuration Endpoint","disabled":false,"info":""},{"id":"b0a01c6c.06d65","type":"tab","label":"Recommandation Endpoint","disabled":false,"info":""},{"id":"b9daa40a.159ce8","type":"tab","label":"Goal Endpoint","disabled":false,"info":""},{"id":"9c58fe86.dc70d","type":"tab","label":"Time Endpoint","disabled":false,"info":""},{"id":"fd561dd2.b6ea58","type":"tab","label":"Settings endpoint","disabled":false,"info":""},{"id":"85ae1227.5aacf8","type":"tab","label":"Create and send file","disabled":false,"info":""},{"id":"e1a9ea8c.adf12","type":"tab","label":"Default parameter","disabled":false,"info":""},{"id":"4e4dbcc2.17d054","type":"subflow","name":"v√©rify token","info":"","in":[{"x":140,"y":320,"wires":[{"id":"e29f42ca.a113c"}]}],"out":[{"x":1160,"y":360,"wires":[{"id":"db0ceff6.603c","port":0}]}]},{"id":"335e86e1.c431da","type":"subflow","name":"keep_alive_watcher","info":"","in":[{"x":60,"y":140,"wires":[{"id":"402e62db.9318dc"}]}],"out":[{"x":1140,"y":140,"wires":[{"id":"54e3eb5e.a5e6a4","port":0}]}]},{"id":"dc840522.071f9","type":"subflow","name":"Create JSON Report","info":"Create a JSON report for a specific timestamp only if the day is in the past. Otherwise msg.filename is the filename and msg.payload is the file content","category":"","in":[{"x":100,"y":860,"wires":[{"id":"3fd9bd41.6f8fb2"}]}],"out":[{"x":3100,"y":780,"wires":[{"id":"b8f0ca7c.103548","port":0}]}]},{"id":"8583948d.d27ea","type":"subflow","name":"Log","info":"Write to a logfile named movit.log","category":"","in":[{"x":200,"y":160,"wires":[{"id":"69ad52be.f4ac04"}]}],"out":[{"x":1080,"y":160,"wires":[{"id":"7ee4cf58.8627","port":0}]}]},{"id":"aa0f77d4.90b038","type":"subflow","name":"Retreive log","info":"","category":"","in":[{"x":200,"y":200,"wires":[{"id":"a43e21f1.be1f3"}]}],"out":[{"x":660,"y":200,"wires":[{"id":"a43e21f1.be1f3","port":0}]}]},{"id":"3ba2a49e.7ce77c","type":"mongodb","z":"","hostname":"127.0.0.1","port":"27017","db":"MovIt","name":""},{"id":"311fce6b.a3ffd2","type":"mongodb2","name":""},{"id":"c2e023a5.ad0b","type":"mongodb2","z":"","uri":"mongodb://127.0.0.1:27017/MovIt","name":"MovIt","options":"","parallelism":"10"},{"id":"94e4b2c8.735b8","type":"mongodb2","z":"","uri":"","name":"","options":"","parallelism":"-1"},{"id":"2b8661c7.194ede","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"ba331956.2c3558","type":"ftp","z":"","host":"192.168.2.228","port":"22","secureOptions":"","user":"pi","connTimeout":"","pasvTimeout":"","keepalive":"","password":"raspberry"},{"id":"e61fab25.c40b38","type":"sftp","z":"","host":"192.168.2.228","port":"22","username":"pi","password":"raspberry","hmac":"hmac-sha2-256,hmac-sha2-512,hmac-sha1","cipher":"aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm"},{"id":"8c99f6d6.ddd4d","type":"websocket-listener","z":"","path":"/ws/chairState","wholemsg":"false"},{"id":"fb6081dd.109bf","type":"websocket-listener","z":"","path":"/ws/rawData","wholemsg":"false"},{"id":"3f158145.0b3c46","type":"websocket-listener","z":"","path":"/ws/angleFSM","wholemsg":"false"},{"id":"c3eb9ecd.694a1","type":"websocket-listener","z":"","path":"/ws/travelFSM","wholemsg":"false"},{"id":"76042830.e1476","type":"websocket-listener","z":"","path":"/ws/seatingFSM","wholemsg":"false"},{"id":"35da5e0a.8bfcca","type":"sftp","z":"","host":"www.cati.telask.ca","port":"22","username":"","password":"","hmac":"hmac-sha2-256,hmac-sha2-512,hmac-sha1","cipher":"aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm"},{"id":"df33e3dc.47d9","type":"sftp","z":"","host":"localhost","port":"22","username":"pi","password":"raspberry","hmac":"hmac-sha2-256,hmac-sha2-512,hmac-sha1","cipher":"aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm"},{"id":"71f6ec46.a70074","type":"websocket-listener","z":"","path":"/ws/notificationFSM","wholemsg":"false"},{"id":"e9a4e134.0416a","type":"http in","z":"62e9dd9c.3ec8b4","name":"","url":"/login","method":"post","upload":false,"swaggerDoc":"","x":150,"y":140,"wires":[["d7376764.918e88"]]},{"id":"c0aafdb5.90b58","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find user","collection":"User","operation":"findOne","x":660,"y":140,"wires":[["33c4d6e7.62eb2a"]]},{"id":"d7376764.918e88","type":"function","z":"62e9dd9c.3ec8b4","name":"get Username","func":"msg.payload= '{\"username\":\"'+msg.req.body.username+'\"}';\nvar crypto = context.global.cryptojs;\nmsg.pw = crypto.SHA256( msg.req.body.password).toString();\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["8386b3b8.afc4d"]]},{"id":"8386b3b8.afc4d","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"payload","action":"obj","pretty":false,"x":510,"y":140,"wires":[["c0aafdb5.90b58"]]},{"id":"33c4d6e7.62eb2a","type":"function","z":"62e9dd9c.3ec8b4","name":"validate Password","func":"if(msg.payload.password == msg.pw){\n    var token = context.global.cryptojs.lib.WordArray.random(32).toString();\n    msg.result ='{\"result\":0,\"token\":\"'+token+'\"}';\n    msg.payload.token= token;\n    msg.query ={\"username\":msg.payload.username}\n    msg.value= {\"username\":msg.payload.username,\"password\":msg.payload.password,\"token\":msg.payload.token};\n    msg.payload = [];\n    msg.payload[0]= msg.query;\n    msg.payload[1]=msg.value;\n}\nelse\n    msg.result = '{\"result\":401}';\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":140,"wires":[["89587608.3c4368"]]},{"id":"f787b8dd.85b708","type":"switch","z":"62e9dd9c.3ec8b4","name":"","property":"result.result","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1170,"y":140,"wires":[["a7bcd925.e25508"],["4b672da8.cf9b54"]]},{"id":"a7bcd925.e25508","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"create token","collection":"User","operation":"findOneAndUpdate","x":1310,"y":100,"wires":[["4b672da8.cf9b54"]]},{"id":"a306472a.48f6f8","type":"http response","z":"62e9dd9c.3ec8b4","name":"","statusCode":"","headers":{},"x":1650,"y":140,"wires":[]},{"id":"4b672da8.cf9b54","type":"function","z":"62e9dd9c.3ec8b4","name":"send result","func":"msg.payload = msg.result;\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":140,"wires":[["a306472a.48f6f8"]]},{"id":"89587608.3c4368","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"result","action":"obj","pretty":false,"x":1030,"y":140,"wires":[["f787b8dd.85b708"]]},{"id":"922360f7.46ec","type":"json","z":"4e4dbcc2.17d054","name":"","property":"payload","action":"obj","pretty":false,"x":430,"y":320,"wires":[["445de54c.95801c"]]},{"id":"16daffa2.467b7","type":"mongodb2 in","z":"4e4dbcc2.17d054","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"User","operation":"findOne","x":760,"y":340,"wires":[["b0d913b4.e7c34"]]},{"id":"b0d913b4.e7c34","type":"switch","z":"4e4dbcc2.17d054","name":"result","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":340,"wires":[["50caa40d.80abec"],["db0ceff6.603c"]]},{"id":"445de54c.95801c","type":"function","z":"4e4dbcc2.17d054","name":"","func":"msg.payload = {token:msg.payload.authorization};\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":340,"wires":[["16daffa2.467b7"]]},{"id":"aba7736e.afb03","type":"http response","z":"4e4dbcc2.17d054","name":"","statusCode":"","headers":{},"x":1170,"y":320,"wires":[]},{"id":"e29f42ca.a113c","type":"function","z":"4e4dbcc2.17d054","name":"get body","func":"msg.backup=msg.payload ;\nmsg.payload = msg.req.headers;\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":320,"wires":[["922360f7.46ec"]]},{"id":"db0ceff6.603c","type":"function","z":"4e4dbcc2.17d054","name":"get body","func":"msg.payload=msg.backup ;\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":360,"wires":[[]]},{"id":"d58ab2a6.9d44e","type":"http in","z":"62e9dd9c.3ec8b4","name":"","url":"/changePassword","method":"post","upload":false,"swaggerDoc":"","x":110,"y":280,"wires":[["2837a1dc.2d708e"]]},{"id":"2837a1dc.2d708e","type":"function","z":"62e9dd9c.3ec8b4","name":"get Username","func":"msg.payload= '{\"username\":\"'+msg.req.body.username+'\"}';\nvar crypto = context.global.cryptojs;\nmsg.pw = crypto.SHA256( msg.req.body.password).toString();\nmsg.newPassword = crypto.SHA256( msg.req.body.newPassword).toString();\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":280,"wires":[["9ea82417.491cb8"]]},{"id":"9e80e969.bc5eb8","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find user","collection":"User","operation":"findOne","x":660,"y":280,"wires":[["5c9515bf.c1de6c"]]},{"id":"9ea82417.491cb8","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"payload","action":"obj","pretty":false,"x":510,"y":280,"wires":[["9e80e969.bc5eb8"]]},{"id":"5c9515bf.c1de6c","type":"function","z":"62e9dd9c.3ec8b4","name":"validate Password","func":"if(msg.payload.password == msg.pw){\n    msg.payload =[{username:msg.payload.username},{$set:{\"password\":msg.newPassword}}];\n        msg.result = '{\"result\":\"0\"}';\n}\nelse\n    msg.result = '{\"result\":401}';\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":280,"wires":[["1ee344bd.f16f0b"]]},{"id":"1ee344bd.f16f0b","type":"json","z":"62e9dd9c.3ec8b4","name":"","property":"result","action":"obj","pretty":false,"x":1030,"y":280,"wires":[["88f93e56.526c5"]]},{"id":"88f93e56.526c5","type":"switch","z":"62e9dd9c.3ec8b4","name":"","property":"result.result","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"neq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1170,"y":280,"wires":[["d56ef679.fb5018"],["1ac988a8.1b48e7"]]},{"id":"d56ef679.fb5018","type":"mongodb2 in","z":"62e9dd9c.3ec8b4","service":"_ext_","configNode":"c2e023a5.ad0b","name":"change password","collection":"User","operation":"update","x":1350,"y":240,"wires":[["1ac988a8.1b48e7"]]},{"id":"bd8c13e2.e69f6","type":"http response","z":"62e9dd9c.3ec8b4","name":"","statusCode":"","headers":{},"x":1710,"y":280,"wires":[]},{"id":"1ac988a8.1b48e7","type":"function","z":"62e9dd9c.3ec8b4","name":"send result","func":"msg.payload = msg.result;\nreturn msg;","outputs":1,"noerr":0,"x":1550,"y":280,"wires":[["bd8c13e2.e69f6"]]},{"id":"cde0e0b7.51abe","type":"http response","z":"b9daa40a.159ce8","name":"","statusCode":"","headers":{},"x":850,"y":140,"wires":[]},{"id":"21ca71e5.fbb5fe","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/goal","method":"get","upload":false,"swaggerDoc":"","x":160,"y":240,"wires":[["380d1904.c4e1d6"]]},{"id":"fd58072b.243318","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":640,"y":240,"wires":[["74bd7263.339dbc"]]},{"id":"e995576.05dbaa8","type":"function","z":"b9daa40a.159ce8","name":"","func":"var request = [{\"Value\":\"Goal\"},msg.payload];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":240,"wires":[["fd58072b.243318"]]},{"id":"2b4014f9.e62f9c","type":"http in","z":"b9daa40a.159ce8","name":"","url":"/goal","method":"post","upload":false,"swaggerDoc":"","x":160,"y":120,"wires":[["19092c9d.73cff3"]]},{"id":"c2165ebd.f4e88","type":"function","z":"b9daa40a.159ce8","name":"","func":"msg.payload =[{Value:\"Goal\"},{\"$set\":msg.req.body || {\"tiltAngle\" : 0,\"tiltFrequency\" : 0,\"tiltLength\" : 0}}];\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":120,"wires":[["62d22b6c.9fe194"]]},{"id":"62d22b6c.9fe194","type":"mongodb2 in","z":"b9daa40a.159ce8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Config","operation":"update","x":670,"y":120,"wires":[["cde0e0b7.51abe","8545f6a9.272de8"]]},{"id":"50caa40d.80abec","type":"function","z":"4e4dbcc2.17d054","name":"","func":"    msg.statusCode = 401\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":320,"wires":[["aba7736e.afb03"]]},{"id":"402e62db.9318dc","type":"json","z":"335e86e1.c431da","name":"","property":"payload","action":"obj","pretty":false,"x":170,"y":140,"wires":[["d2a339de.094b78"]]},{"id":"d2a339de.094b78","type":"function","z":"335e86e1.c431da","name":"","func":" msg.backup=msg.payload;\n\n msg.payload =[[{ \"$match\": { Value: \"CurrentState\" } },\n  { \"$project\": { \n         \"keepAlive\": \"$keepAlive\"\n    }}\n   ]];\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":140,"wires":[["bb89477c.b47ab8"]]},{"id":"bb89477c.b47ab8","type":"mongodb2 in","z":"335e86e1.c431da","service":"_ext_","configNode":"c2e023a5.ad0b","name":"getKeepAlive","collection":"Current_State","operation":"aggregate.toArray","x":470,"y":140,"wires":[["2ab055df.86637a"]]},{"id":"2ab055df.86637a","type":"function","z":"335e86e1.c431da","name":"get body","func":"msg.keepAlive =msg.payload[0].keepAlive;\n\nif((msg.backup.datetime - msg.keepAlive) > 900)\n    msg.result =0;\nelse\n    msg.result=1;\nmsg.payload =msg.backup;\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":140,"wires":[["1bef11f.97294ee"]]},{"id":"1bef11f.97294ee","type":"switch","z":"335e86e1.c431da","name":"","property":"result","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":140,"wires":[["4618534d.db9b9c"],["54e3eb5e.a5e6a4"]]},{"id":"1c8dfbb9.335e14","type":"mongodb2 in","z":"335e86e1.c431da","service":"_ext_","configNode":"c2e023a5.ad0b","name":"LastTime","collection":"back_angle","operation":"aggregate.toArray","x":400,"y":340,"wires":[["cbec3b20.10a8e8"]]},{"id":"cbec3b20.10a8e8","type":"function","z":"335e86e1.c431da","name":"","func":"//timestamp = msg.payload[0].date.getTime()+900000;\n//msg.payload={\n//    angle:msg.payload[0].angle, date:new Date(timestamp),timestamp:parseInt(timestamp),sitting:0\n//}\n\nmsg.payload =[{date:msg.payload[0].date},{$set:{\"isSitting\":0}}];\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":340,"wires":[["338ef8ef.ab3eb8","ca2109b4.2d07a8"]]},{"id":"338ef8ef.ab3eb8","type":"mongodb2 in","z":"335e86e1.c431da","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"back_angle","operation":"update","x":740,"y":340,"wires":[["54e3eb5e.a5e6a4"]]},{"id":"4618534d.db9b9c","type":"function","z":"335e86e1.c431da","name":"","func":"var date = new Date(msg.payload.datetime*1000);\n       date.setUTCMinutes(date.getMinutes()-date.getTimezoneOffset());\n msg.payload =[[\n     {\n         \"$sort\":{date: 1}\n     },\n    {\n        \"$group\":{\n            \"_id\":null,\n            \"date\":{$last:\"$date\"},\n            \"angle\":{$last:\"$angle\"}\n        }\n    }\n   ]];\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":340,"wires":[["1c8dfbb9.335e14"]]},{"id":"54e3eb5e.a5e6a4","type":"function","z":"335e86e1.c431da","name":"","func":"msg.payload = msg.backup;\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":260,"wires":[[]]},{"id":"ca2109b4.2d07a8","type":"mongodb2 in","z":"335e86e1.c431da","service":"_ext_","configNode":"c2e023a5.ad0b","name":"insert test","collection":"sitting_time","operation":"update","x":740,"y":400,"wires":[[]]},{"id":"19092c9d.73cff3","type":"subflow:4e4dbcc2.17d054","z":"b9daa40a.159ce8","name":"","x":330,"y":120,"wires":[["c2165ebd.f4e88"]]},{"id":"380d1904.c4e1d6","type":"subflow:4e4dbcc2.17d054","z":"b9daa40a.159ce8","name":"","x":330,"y":240,"wires":[["e995576.05dbaa8"]]},{"id":"2b797cc9.55803c","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"fsm/angle","qos":"2","broker":"2b8661c7.194ede","x":340,"y":140,"wires":[["647eada9.e20064","b0013f36.edc098"]]},{"id":"2b5a7292.9da80e","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"fsm/travel","qos":"2","broker":"2b8661c7.194ede","x":340,"y":240,"wires":[["addd7d20.08c168","e9e037fc.a92f18"]]},{"id":"26527287.6147e6","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"fsm/seating","qos":"2","broker":"2b8661c7.194ede","x":330,"y":340,"wires":[["1338d6c7.b90411","b0ed070c.b8b598"]]},{"id":"dcb224b1.4cdc58","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"sensors/rawData","qos":"2","broker":"2b8661c7.194ede","x":320,"y":720,"wires":[["78035ea0.e38518","c49e85a9.4d5e6"]]},{"id":"647eada9.e20064","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":140,"wires":[["22809ed2.60491a"]]},{"id":"addd7d20.08c168","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":240,"wires":[["c52a1be5.0c7dd"]]},{"id":"1338d6c7.b90411","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":340,"wires":[["286461c8.8594e6"]]},{"id":"78035ea0.e38518","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":720,"wires":[[]]},{"id":"7018a1.285b676","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":590,"y":580,"wires":[["4606765b.afe4f8","e853760.d742f08","9c4a6dac.8b4148"]]},{"id":"286461c8.8594e6","type":"switch","z":"d8422fcd.8b4f88","name":"Check State","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"},{"t":"eq","v":"Stopped","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":340,"wires":[["9e09dd8e.4188f","b1ea733a.e03f8"],["9e09dd8e.4188f","b1ea733a.e03f8"]]},{"id":"9e09dd8e.4188f","type":"function","z":"d8422fcd.8b4f88","name":"setSeatingState","func":"flow.set('seatingState',msg.payload.event);\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":360,"wires":[[]]},{"id":"4606765b.afe4f8","type":"function","z":"d8422fcd.8b4f88","name":"checkIfSeatingStarted","func":"msg.state = flow.get('seatingState') || \"\";\n\nif(msg.state != \"Started\") {\n    node.status({fill:\"red\",shape:\"dot\",text:\"Stopped\"});\n    return null\n}\nnode.status({fill:\"green\",shape:\"dot\",text:\"Started\"});\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":520,"wires":[["afb0df84.a8dc88"]]},{"id":"788ff443.44a794","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"sensors/chairState","qos":"2","broker":"2b8661c7.194ede","x":310,"y":580,"wires":[["7018a1.285b676","599cbca8.086fc4"]]},{"id":"afb0df84.a8dc88","type":"switch","z":"d8422fcd.8b4f88","name":"Not null","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":980,"y":520,"wires":[["19bf81f4.4443fe"]]},{"id":"22809ed2.60491a","type":"switch","z":"d8422fcd.8b4f88","name":"Check State","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"},{"t":"eq","v":"Stopped","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":140,"wires":[["42c00fa2.827d58","305676e0.8ba3c2"],["42c00fa2.827d58","305676e0.8ba3c2"]]},{"id":"42c00fa2.827d58","type":"function","z":"d8422fcd.8b4f88","name":"setAngleState","func":"flow.set('angleState',msg.payload.event);\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":160,"wires":[[]]},{"id":"c52a1be5.0c7dd","type":"switch","z":"d8422fcd.8b4f88","name":"Check State","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"},{"t":"eq","v":"Stopped","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":240,"wires":[["e4619c2e.c11848","f0a1d7bb.3e4aa"],["e4619c2e.c11848","f0a1d7bb.3e4aa"]]},{"id":"e4619c2e.c11848","type":"function","z":"d8422fcd.8b4f88","name":"setTravelState","func":"flow.set('travelState',msg.payload.event);\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":260,"wires":[[]]},{"id":"e853760.d742f08","type":"function","z":"d8422fcd.8b4f88","name":"checkIfTravelStarted","func":"msg.state = flow.get('travelState') || \"\";\nif(msg.state != \"Started\") {\n    node.status({fill:\"red\",shape:\"dot\",text:\"Stopped\"});\n    return null\n}\nnode.status({fill:\"green\",shape:\"dot\",text:\"Started\"});\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":580,"wires":[["e93cf1a.f6aa71"]]},{"id":"9c4a6dac.8b4148","type":"function","z":"d8422fcd.8b4f88","name":"checkIfAngleStarted","func":"msg.state = flow.get('angleState') || \"\";\nif(msg.state != \"Started\") {\n    node.status({fill:\"red\",shape:\"dot\",text:\"Stopped\"});\n    return null\n}\nnode.status({fill:\"green\",shape:\"dot\",text:\"Started\"});\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":640,"wires":[["9fd4ca68.283ef"]]},{"id":"e93cf1a.f6aa71","type":"switch","z":"d8422fcd.8b4f88","name":"Not null","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":980,"y":580,"wires":[["cbc792a.37f63f"]]},{"id":"9fd4ca68.283ef","type":"switch","z":"d8422fcd.8b4f88","name":"Not null","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":980,"y":640,"wires":[["5e0e3ca3.73f30c"]]},{"id":"f3ea0a77.2c355","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingState","operation":"insertOne","x":1090,"y":320,"wires":[[]]},{"id":"b1ea733a.e03f8","type":"change","z":"d8422fcd.8b4f88","name":"","rules":[{"t":"delete","p":"payload.stateNum","pt":"msg"},{"t":"delete","p":"payload.stateName","pt":"msg"},{"t":"move","p":"payload.event","pt":"msg","to":"payload.state","tot":"msg"},{"t":"delete","p":"payload.event","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":320,"wires":[["f3ea0a77.2c355"]]},{"id":"face17ac.f6c5f","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelState","operation":"insertOne","x":1080,"y":220,"wires":[[]]},{"id":"f0a1d7bb.3e4aa","type":"change","z":"d8422fcd.8b4f88","name":"","rules":[{"t":"delete","p":"payload.stateNum","pt":"msg"},{"t":"delete","p":"payload.stateName","pt":"msg"},{"t":"move","p":"payload.event","pt":"msg","to":"payload.state","tot":"msg"},{"t":"delete","p":"payload.event","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":220,"wires":[["face17ac.f6c5f"]]},{"id":"fc51736a.6101a","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"insertOne","x":1080,"y":120,"wires":[[]]},{"id":"305676e0.8ba3c2","type":"change","z":"d8422fcd.8b4f88","name":"","rules":[{"t":"delete","p":"payload.stateNum","pt":"msg"},{"t":"delete","p":"payload.stateName","pt":"msg"},{"t":"move","p":"payload.event","pt":"msg","to":"payload.state","tot":"msg"},{"t":"delete","p":"payload.event","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":120,"wires":[["fc51736a.6101a"]]},{"id":"19bf81f4.4443fe","type":"change","z":"d8422fcd.8b4f88","name":"KeepPressureOnly","rules":[{"t":"delete","p":"payload.Travel","pt":"msg"},{"t":"move","p":"payload.Angle.seatAngle","pt":"msg","to":"payload.angle","tot":"msg"},{"t":"delete","p":"payload.Angle","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1170,"y":520,"wires":[["467c0bed.ccbe64"]]},{"id":"d41c5eed.0eee88","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"insertOne","x":1880,"y":520,"wires":[[]]},{"id":"cbc792a.37f63f","type":"change","z":"d8422fcd.8b4f88","name":"KeepTravelOnly","rules":[{"t":"delete","p":"payload.Pressure","pt":"msg"},{"t":"move","p":"payload.Angle.seatAngle","pt":"msg","to":"payload.seatAngle","tot":"msg"},{"t":"delete","p":"payload.snoozeButton","pt":"msg"},{"t":"set","p":"payload.isMoving","pt":"msg","to":"payload.Travel.isMoving","tot":"msg"},{"t":"set","p":"payload.lastDistance","pt":"msg","to":"payload.Travel.lastDistance","tot":"msg"},{"t":"delete","p":"payload.Travel","pt":"msg"},{"t":"delete","p":"payload.Angle","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1160,"y":580,"wires":[["fea79023.4b70d"]]},{"id":"da24f93e.ddda9","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelData","operation":"insertOne","x":1880,"y":580,"wires":[[]]},{"id":"5e0e3ca3.73f30c","type":"change","z":"d8422fcd.8b4f88","name":"KeepAngleOnly","rules":[{"t":"delete","p":"payload.Travel","pt":"msg"},{"t":"delete","p":"payload.Pressure","pt":"msg"},{"t":"move","p":"payload.Angle.seatAngle","pt":"msg","to":"payload.Angle","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1160,"y":640,"wires":[["fc4016c9.a30dd"]]},{"id":"24d7017f.e639d6","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleData","operation":"insertOne","x":1880,"y":640,"wires":[[]]},{"id":"c49e85a9.4d5e6","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"fb6081dd.109bf","client":"","x":530,"y":660,"wires":[]},{"id":"fc4016c9.a30dd","type":"function","z":"d8422fcd.8b4f88","name":"limitLoggingToOneHertzAngle","func":"if((flow.get('angleTime') || 0) != msg.payload.time) {\n    flow.set('angleTime',msg.payload.time);\n    msg.shouldLog = 1;\n} else {\n    msg.shouldLog = 0;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1410,"y":640,"wires":[["cc3c65b5.d9cde8"]]},{"id":"cc3c65b5.d9cde8","type":"switch","z":"d8422fcd.8b4f88","name":"ShouldLog","property":"shouldLog","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1650,"y":640,"wires":[["24d7017f.e639d6"]]},{"id":"19e75aa3.293e75","type":"switch","z":"d8422fcd.8b4f88","name":"ShouldLog","property":"shouldLog","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1650,"y":580,"wires":[["da24f93e.ddda9"]]},{"id":"fea79023.4b70d","type":"function","z":"d8422fcd.8b4f88","name":"limitLoggingToOneHertzTravel","func":"if((flow.get('travelTime') || 0) != msg.payload.time) {\n    flow.set('travelTime',msg.payload.time);\n    msg.shouldLog = 1;\n} else {\n    msg.shouldLog = 0;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1410,"y":580,"wires":[["19e75aa3.293e75"]]},{"id":"73579fdc.51c5c8","type":"switch","z":"d8422fcd.8b4f88","name":"ShouldLog","property":"shouldLog","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1670,"y":520,"wires":[["d41c5eed.0eee88"]]},{"id":"467c0bed.ccbe64","type":"function","z":"d8422fcd.8b4f88","name":"limitLoggingToOnePerThirtyPressure","func":"var timeBetweenReading = 30\n\nif(((flow.get('pressureTime') || timeBetweenReading) + timeBetweenReading) <= msg.payload.time) {\n    flow.set('pressureTime',msg.payload.time);\n    msg.shouldLog = 1;\n} else {\n    msg.shouldLog = 0;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":520,"wires":[["73579fdc.51c5c8"]]},{"id":"293469a9.3159c6","type":"http in","z":"d8422fcd.8b4f88","name":"","url":"/debug","method":"get","upload":false,"swaggerDoc":"","x":330,"y":940,"wires":[["89774864.1d3718"]]},{"id":"7feb16d8.6793d8","type":"http response","z":"d8422fcd.8b4f88","name":"","statusCode":"","headers":{},"x":810,"y":940,"wires":[]},{"id":"489cc160.a2f92","type":"template","z":"d8422fcd.8b4f88","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"utf-8\">\n    <title>Debug Data</title>\n    <style type=\"text/css\">\n\n\n    #wrapper {\n        text-align: center;\n    }\n    #container {\n        display: inline-block;\n    }\n\n    .data{\n        float:left;\n        text-align: left;\n        margin: 10px 30px 0px;\n    }\n\n    </style>\n          <script type = \"text/javascript\">\n            if (\"WebSocket\" in window) {\n               // Let us open a web socket\n               var wsChairState = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/chairState\");\n               var wsRawData = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/rawData\");\n               var wsAngleFSM = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/angleFSM\");\n               var wsTravelFSM = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/travelFSM\");\n               var wsSeatingFSM = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/seatingFSM\");\n               var wsNotificationFSM = new WebSocket(\"ws://{{payload.0.address}}:1880/ws/notificationFSM\");\n\t\t\t\t\n               wsChairState.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  document.getElementById(\"chairDiv\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n\n               wsRawData.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  document.getElementById(\"rawDiv\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n               \n               wsAngleFSM.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  console.log(received_msg)\n                  document.getElementById(\"angleFSM\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n               \n               wsTravelFSM.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  document.getElementById(\"travelFSM\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n               \n               wsSeatingFSM.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  document.getElementById(\"seatingFSM\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n               \n               wsNotificationFSM.onmessage = function (evt) { \n                  var received_msg = evt.data;\n                  document.getElementById(\"notificationFSM\").innerHTML = JSON.stringify(JSON.parse(received_msg), undefined, 2);\n               };\n\n            }\n      </script>\n</head>\n<body>\n    <div id=\"wrapper\">    \n        <div id=\"container\">\n            <div class = \"data\">\n                <h1>Raw Data:</h1>\n                <pre id = \"rawDiv\"></pre>\n            </div>\n            <div class = \"data\">\n                <h1>Chair state:</h1>\n                <pre id = \"chairDiv\"></pre>\n            </div>\n            <div class = \"data\">\n                <h1>AngleFSM:</h1>\n                <pre id = \"angleFSM\"></pre>\n            </div>\n            <div class = \"data\">\n                <h1>TravelFSM:</h1>\n                <pre id = \"travelFSM\"></pre>\n            </div>\n            <div class = \"data\">\n                <h1>SeatingFSM:</h1>\n                <pre id = \"seatingFSM\"></pre>\n            </div>\n            <div class = \"data\">\n                <h1>NotificationFSM:</h1>\n                <pre id = \"notificationFSM\"></pre>\n            </div>\n            </div>\n    </div>\n</body>\n</html>","output":"str","x":660,"y":940,"wires":[["7feb16d8.6793d8"]]},{"id":"89774864.1d3718","type":"hostip","z":"d8422fcd.8b4f88","name":"Host IP","x":500,"y":940,"wires":[["489cc160.a2f92"]]},{"id":"a6789b30.267e1","type":"http in","z":"28ede86e.b0dc6","name":"","url":"/configuration","method":"get","upload":false,"swaggerDoc":"","x":170,"y":160,"wires":[["ed8c1478.c9a1b"]]},{"id":"1c6943a6.7dd72c","type":"mongodb2 in","z":"28ede86e.b0dc6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":780,"y":160,"wires":[["2376e0d7.8eb478"]]},{"id":"1d5decda.261d5b","type":"function","z":"28ede86e.b0dc6","name":"Create Request","func":"var request = [{\"Value\":\"Configuration\"},msg.payload];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":160,"wires":[["1c6943a6.7dd72c"]]},{"id":"ed8c1478.c9a1b","type":"subflow:4e4dbcc2.17d054","z":"28ede86e.b0dc6","name":"","x":370,"y":160,"wires":[["1d5decda.261d5b"]]},{"id":"2376e0d7.8eb478","type":"http response","z":"28ede86e.b0dc6","name":"","statusCode":"","headers":{},"x":970,"y":160,"wires":[]},{"id":"6fdd0f43.a8c0f8","type":"comment","z":"28ede86e.b0dc6","name":"R√©cupere ou Modifie les configurations","info":"","x":230,"y":100,"wires":[]},{"id":"9f83411d.e87788","type":"mongodb2 in","z":"28ede86e.b0dc6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configurations","collection":"Config","operation":"update","x":780,"y":220,"wires":[["e07aa08.0ed3d6"]]},{"id":"cfb5fcca.2f4278","type":"http in","z":"28ede86e.b0dc6","name":"","url":"/configuration","method":"post","upload":false,"swaggerDoc":"","x":170,"y":220,"wires":[["6e67a31.d5a8d5c"]]},{"id":"c30cbc89.1a4728","type":"function","z":"28ede86e.b0dc6","name":"Create Request","func":"msg.payload =[{Value:\"Configuration\"},{$set:msg.req.body}];\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":220,"wires":[["9f83411d.e87788"]]},{"id":"6e67a31.d5a8d5c","type":"subflow:4e4dbcc2.17d054","z":"28ede86e.b0dc6","name":"","x":370,"y":220,"wires":[["c30cbc89.1a4728"]]},{"id":"e07aa08.0ed3d6","type":"http response","z":"28ede86e.b0dc6","name":"","statusCode":"","headers":{},"x":970,"y":220,"wires":[]},{"id":"72042046.97fe98","type":"http in","z":"b0a01c6c.06d65","name":"","url":"/recommandation","method":"get","upload":false,"swaggerDoc":"","x":300,"y":220,"wires":[["d7bd7d1d.603888"]]},{"id":"2a623c4d.e02154","type":"mongodb2 in","z":"b0a01c6c.06d65","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":820,"y":220,"wires":[["bf58a25a.9ba9f8"]]},{"id":"daf732f5.1eb138","type":"function","z":"b0a01c6c.06d65","name":"","func":"var request = [{\"Value\":\"Recommandation\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":220,"wires":[["2a623c4d.e02154"]]},{"id":"d7bd7d1d.603888","type":"subflow:4e4dbcc2.17d054","z":"b0a01c6c.06d65","name":"","x":510,"y":220,"wires":[["daf732f5.1eb138"]]},{"id":"75981a82.b8815c","type":"http in","z":"b0a01c6c.06d65","name":"","url":"/recommandation","method":"post","upload":false,"swaggerDoc":"","x":300,"y":320,"wires":[["55b4ab83.ab4e7c"]]},{"id":"8e5430d.5b8525","type":"function","z":"b0a01c6c.06d65","name":"","func":"var rcv = msg.req.body\nvar data = {}\ndata.Value = rcv.Value || \"Recommandation\"\ndata.allowRest = rcv.allowRest || \"\"\ndata.easeTransfers = rcv.easeTransfers || \"\"\ndata.improveComfort = rcv.improveComfort || \"\"\ndata.other = {}\nvar tmp = rcv.other || {}\ndata.other.title = tmp.title || \"\"\ndata.other.value = tmp.value || \"\"\ndata.reducePain = rcv.reducePain || \"\"\ndata.reduceSlidingMoving = rcv.reduceSlidingMoving || 0\ndata.reduceSlidingRest = rcv.reduceSlidingRest || 0\ndata.reduceSwelling = rcv.reduceSwelling || \"\"\ndata.reduceWeight = {}\nvar tmp = rcv.reduceWeight || {}\ndata.reduceWeight.tiltFrequency = tmp.tiltFrequency || 0\ndata.reduceWeight.tiltLength = tmp.tiltLength || 0\ndata.reduceWeight.tiltAngle = tmp.tiltAngle || 0\n\nmsg.payload =[{Value:\"Recommandation\"},{$set:data}];\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":320,"wires":[["2b13321d.e22b5e"]]},{"id":"55b4ab83.ab4e7c","type":"subflow:4e4dbcc2.17d054","z":"b0a01c6c.06d65","name":"","x":510,"y":320,"wires":[["8e5430d.5b8525"]]},{"id":"bf58a25a.9ba9f8","type":"http response","z":"b0a01c6c.06d65","name":"","statusCode":"","headers":{},"x":970,"y":220,"wires":[]},{"id":"2b13321d.e22b5e","type":"mongodb2 in","z":"b0a01c6c.06d65","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"Config","operation":"update","x":850,"y":320,"wires":[["39e3c76d.ccc6d","edf8d164.f4cea"]]},{"id":"39e3c76d.ccc6d","type":"http response","z":"b0a01c6c.06d65","name":"","statusCode":"","headers":{},"x":1030,"y":340,"wires":[]},{"id":"edf8d164.f4cea","type":"template","z":"b0a01c6c.06d65","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{req.body.reduceWeight.tiltFrequency}}:{{req.body.reduceWeight.tiltLength}}:{{req.body.reduceWeight.tiltAngle}}","output":"str","x":1040,"y":300,"wires":[["5dd5450f.589f74"]]},{"id":"5dd5450f.589f74","type":"mqtt out","z":"b0a01c6c.06d65","name":"","topic":"goal/update_data","qos":"","retain":"","broker":"2b8661c7.194ede","x":1230,"y":300,"wires":[]},{"id":"e669f6bf.29a8","type":"comment","z":"b0a01c6c.06d65","name":"R√©cup√®re/Modifie les recommandation","info":"Envoie √©galement les donn√©es via mqtt de sort a changer la machine a √©tat fini","x":350,"y":160,"wires":[]},{"id":"74bd7263.339dbc","type":"http response","z":"b9daa40a.159ce8","name":"","statusCode":"","headers":{},"x":790,"y":240,"wires":[]},{"id":"8545f6a9.272de8","type":"template","z":"b9daa40a.159ce8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{req.body.tiltFrequency}}:{{req.body.tiltLength}}:{{req.body.tiltAngle}}","output":"str","x":860,"y":100,"wires":[["726a2c8f.af4a1c"]]},{"id":"726a2c8f.af4a1c","type":"mqtt out","z":"b9daa40a.159ce8","name":"","topic":"goal/update_data","qos":"","retain":"","broker":"2b8661c7.194ede","x":1030,"y":100,"wires":[]},{"id":"1a121ff7.8e7418","type":"http in","z":"9c58fe86.dc70d","name":"","url":"/lastDate","method":"get","upload":false,"swaggerDoc":"","x":210,"y":60,"wires":[["edd2dcfa.c686b8"]]},{"id":"d58df6bb.b9ab3","type":"http response","z":"9c58fe86.dc70d","name":"","statusCode":"","headers":{},"x":590,"y":60,"wires":[]},{"id":"553cf646.02fc3","type":"http in","z":"785b00cb.55902","name":"","url":"/dailySuccessfulTilts","method":"get","upload":false,"swaggerDoc":"","x":670,"y":240,"wires":[["7fd6d4b8.cba10c"]]},{"id":"29f2ac7c.f4e9a4","type":"http response","z":"785b00cb.55902","name":"","statusCode":"","headers":{},"x":2530,"y":300,"wires":[]},{"id":"e4fbc5f.4c8f838","type":"http in","z":"785b00cb.55902","name":"","url":"/oneDay","method":"get","upload":false,"swaggerDoc":"","x":630,"y":500,"wires":[["9445ace0.819438"]]},{"id":"666d92ac.5adef4","type":"http response","z":"785b00cb.55902","name":"","statusCode":"","headers":{},"x":2170,"y":500,"wires":[]},{"id":"db90c0c8.51d77","type":"comment","z":"785b00cb.55902","name":"Info request","info":"Parameter Day and Offset\nreturn array[5], number of tilt by category\n0:Bon angle Bonne dur√©e\n1:Bon angle, dur√©e trop courte\n2:Mauvais angle, bonne duree\n3:Non r√©alis√©\n4:Snooz√©","x":630,"y":200,"wires":[]},{"id":"3eeb2efb.6a4cfa","type":"comment","z":"785b00cb.55902","name":"Info request","info":"Parameter Day and Offset\nreturn array[5], time passed in ms\n0:Moins de 0\n1:0 a 15\n2:15 a 30\n3:30 a 45\n4:45 et plus","x":630,"y":460,"wires":[]},{"id":"bdc80b96.bb145","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"find.toArray","x":1320,"y":500,"wires":[["1faeaf3f.8220c1"]]},{"id":"1faeaf3f.8220c1","type":"function","z":"785b00cb.55902","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1], \"data\":[]})\n    }\n  }\n}\nmsg.currentIndex = 0\nreturn msg;","outputs":1,"noerr":0,"x":1560,"y":500,"wires":[["4dd558ca.4a2b5"]]},{"id":"4dd558ca.4a2b5","type":"change","z":"785b00cb.55902","name":"","rules":[{"t":"move","p":"event","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":500,"wires":[["b7e5a565.bb5b9"]]},{"id":"96507728.06ff78","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1080,"y":500,"wires":[["bdc80b96.bb145"]]},{"id":"b7e5a565.bb5b9","type":"function","z":"785b00cb.55902","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    result[0] += msg.payload[i].end.lessThanZero*1000;\n    result[1] += msg.payload[i].end.zeroToFifteen*1000;\n    result[2] += msg.payload[i].end.fifteenToThirty*1000;\n    result[3] += msg.payload[i].end.thirtyToFourtyfive*1000;\n    result[4] += msg.payload[i].end.fourtyfiveAndMore*1000;\n} \nmsg.payload = result\n\nreturn msg;","outputs":1,"noerr":0,"x":1980,"y":500,"wires":[["666d92ac.5adef4"]]},{"id":"edd2dcfa.c686b8","type":"function","z":"9c58fe86.dc70d","name":"Today's date (ms)","func":"var now = new Date();\nmsg.payload = now.getTime() - now.getTimezoneOffset()*60*1000\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":60,"wires":[["d58df6bb.b9ab3"]]},{"id":"9445ace0.819438","type":"function","z":"785b00cb.55902","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day));\nmsg.start = Math.ceil((date.getTime() + msg.payload.Offset*3600000)/1000);\nmsg.end = ((msg.start + 3600*24 - 1))\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":500,"wires":[["96507728.06ff78"]]},{"id":"73d6df4f.43d2e8","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1160,"y":240,"wires":[["bb815225.87593"]]},{"id":"7fd6d4b8.cba10c","type":"function","z":"785b00cb.55902","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day));\nmsg.start = Math.ceil((date.getTime() + msg.payload.Offset*3600000)/1000);\nmsg.end = ((msg.start + 3600*24 - 1))\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":240,"wires":[["73d6df4f.43d2e8","1d7f76d4.946131","9bfd46bb.6c83a8"]]},{"id":"cf67815d.cb009","type":"function","z":"785b00cb.55902","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1]})\n    }\n  }\n}\nmsg.currentIndex = 0\nreturn msg;","outputs":1,"noerr":0,"x":1640,"y":240,"wires":[["ef5a099a.dd3498"]]},{"id":"ef5a099a.dd3498","type":"change","z":"785b00cb.55902","name":"","rules":[{"t":"move","p":"event","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1840,"y":240,"wires":[["28d00bdd.f14d3c"]]},{"id":"bb815225.87593","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"find.toArray","x":1400,"y":240,"wires":[["cf67815d.cb009"]]},{"id":"28d00bdd.f14d3c","type":"function","z":"785b00cb.55902","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\nvar range = 5\nvar lol = [];\nvar lol2 = [];\n\nfor (var i = 0; i < msg.payload.length; i++) {\n  var avg = msg.payload[i].end.average;\n  var elapsed = msg.payload[i].end.elapsed;\n  var duration = msg.payload[i].end.requiredDuration;\n  var angle = msg.payload[i].end.requiredAngle;\n  \n  var goodAngle = (avg >= angle-range && avg <= angle+range);\n  var goodTime = (elapsed >= duration);\n  \n  \n  if(goodAngle && goodTime) {\n      result[0] += 1;\n  } else if(goodAngle && !goodTime) {\n      result[1] += 1;\n  } else if(!goodAngle && goodTime) {\n      result[2] += 1;\n  } else {\n      //result[3] += 1;\n  }\n} \n\nmsg.payload = {\"calculatedTilts\":result}\nreturn msg;","outputs":1,"noerr":0,"x":2060,"y":240,"wires":[["af76bb9f.943848"]]},{"id":"a89a362b.fffc9","type":"comment","z":"785b00cb.55902","name":"TODO","info":"Manque bascule de mauvais angle et mauvaise dur√©e\nBesoin de l'alarme pour controller le snooze et non r√©alis√©","x":2010,"y":200,"wires":[]},{"id":"7ff621c1.02fe3","type":"http in","z":"785b00cb.55902","name":"","url":"/oneMonth","method":"get","upload":false,"swaggerDoc":"","x":600,"y":800,"wires":[["9c831012.32e128"]]},{"id":"451d6d4b.ca6514","type":"comment","z":"785b00cb.55902","name":"Info request","info":"Parameter Day and Offset\nreturn array[5], time passed in ms\n0:Moins de 0\n1:0 a 15\n2:15 a 30\n3:30 a 45\n4:45 et plus","x":610,"y":760,"wires":[]},{"id":"87941cbb.5e103","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"if(msg.index === undefined) {\n    msg.index = 0;\n} else {\n    msg.index++;\n}\n\nmsg.payload = { 'time' : { '$gte' : msg.eachDays[msg.index][0] , '$lte' : msg.eachDays[msg.index][1] } };\n\nreturn msg","outputs":1,"noerr":0,"x":1360,"y":800,"wires":[["1fe636e2.e11159"]]},{"id":"9c831012.32e128","type":"function","z":"785b00cb.55902","name":"Datestamp for whole month","func":"//En format UTC\n\nvar Day = parseInt(msg.payload.Day)\n//var Offset = parseInt(msg.payload.Offset)\n//var localOffset = (-1) * (Offset*60) * 60000;\n\n\nvar date = new Date(Day);\nvar start = new Date(date.getFullYear(), date.getMonth(), 1);\nvar end = new Date(date.getFullYear(), date.getMonth()+1, 0);\n\nmsg.start = (Math.ceil((start.getTime())/1000))\nmsg.end = ((Math.ceil((end.getTime()) + (3600000*24))/1000) - 1)\n\nreturn msg\n","outputs":1,"noerr":0,"x":840,"y":800,"wires":[["22b228eb.ebd038"]]},{"id":"22b228eb.ebd038","type":"function","z":"785b00cb.55902","name":"Timestamp for Each Day","func":"var dtStart = new Date(msg.start*1000);\nvar dtEnd = new Date(dtStart.getFullYear(), dtStart.getMonth()+1, 0)\ndtEnd = new Date((dtEnd.getTime()) + (24*1000*60*60) - 1000)\n\nmsg.numDays = dtEnd.getDate();\n\nvar res = []\n\nfor(var i = 1; i <= msg.numDays; i++) {\n    var t = [];\n    var dt = new Date(dtStart.getFullYear(), dtStart.getMonth(), i) //Current Day\n    var dt2 = new Date(dtStart.getFullYear(), dtStart.getMonth(), i+1) //Day after\n    t.push(Math.ceil(dt.getTime()/1000))\n    dt = new Date((dt.getTime()) + (dt2.getTime()-dt.getTime()))\n    t.push(Math.ceil(dt.getTime()/1000))\n    res.push(t)\n}\n\nmsg.eachDays = res;\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":800,"wires":[["87941cbb.5e103"]]},{"id":"797d02f7.fed8dc","type":"function","z":"785b00cb.55902","name":"Check index","func":"\nif(msg.index < msg.numDays-1) {\n    msg.done = false;\n} else {\n    msg.done = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2310,"y":800,"wires":[["7fa455f2.bcb6c4"]]},{"id":"7fa455f2.bcb6c4","type":"switch","z":"785b00cb.55902","name":"Is Done","property":"done","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2480,"y":740,"wires":[["833fd94f.8de428"],["87941cbb.5e103"]]},{"id":"1fe636e2.e11159","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"find.toArray","x":1610,"y":800,"wires":[["46fe29e8.ad303"]]},{"id":"46fe29e8.ad303","type":"function","z":"785b00cb.55902","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1], \"data\":[]})\n    }\n  }\n}\nmsg.currentIndex = 0\nmsg.payload = msg.event\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":800,"wires":[["e167d923.a4ed48"]]},{"id":"e167d923.a4ed48","type":"function","z":"785b00cb.55902","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    result[0] += msg.payload[i].end.lessThanZero*1000;\n    result[1] += msg.payload[i].end.zeroToFifteen*1000;\n    result[2] += msg.payload[i].end.fifteenToThirty*1000;\n    result[3] += msg.payload[i].end.thirtyToFourtyfive*1000;\n    result[4] += msg.payload[i].end.fourtyfiveAndMore*1000;\n} \n\n\nif(msg.result === undefined) {\n    msg.result = {}\n}\n\nmsg.result[msg.index+1] = result\n\nreturn msg;","outputs":1,"noerr":0,"x":2100,"y":800,"wires":[["797d02f7.fed8dc"]]},{"id":"e7066ff3.4701e","type":"http response","z":"785b00cb.55902","name":"","statusCode":"","headers":{},"x":2870,"y":800,"wires":[]},{"id":"833fd94f.8de428","type":"change","z":"785b00cb.55902","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"result","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2690,"y":800,"wires":[["e7066ff3.4701e","464a69a8.0abe08"]]},{"id":"4553a703.e15688","type":"comment","z":"785b00cb.55902","name":"TODO","info":"Pas d'angle sous 10 degr√©, limit√© par la FSM","x":2030,"y":460,"wires":[]},{"id":"5e14a2c4.1a9c6c","type":"http in","z":"785b00cb.55902","name":"","url":"/monthlySuccessfulTilts","method":"get","upload":false,"swaggerDoc":"","x":420,"y":640,"wires":[["776d6662.101db"]]},{"id":"776d6662.101db","type":"function","z":"785b00cb.55902","name":"Datestamp for whole month","func":"//En format UTC\n\nvar Day = parseInt(msg.payload.Day)\n//var Offset = parseInt(msg.payload.Offset)\n//var localOffset = (-1) * (Offset*60) * 60000;\n\n\nvar date = new Date(Day);\nvar start = new Date(date.getFullYear(), date.getMonth(), 1);\nvar end = new Date(date.getFullYear(), date.getMonth()+1, 0);\n\nmsg.start = (Math.ceil((start.getTime())/1000))\nmsg.end = ((Math.ceil((end.getTime()) + (3600000*24))/1000) - 1)\n\nreturn msg\n","outputs":1,"noerr":0,"x":760,"y":640,"wires":[["a1609906.fbbad"]]},{"id":"a1609906.fbbad","type":"function","z":"785b00cb.55902","name":"Timestamp for Each Day","func":"var dtStart = new Date(msg.start*1000);\nvar dtEnd = new Date(dtStart.getFullYear(), dtStart.getMonth()+1, 0)\ndtEnd = new Date((dtEnd.getTime()) + (24*1000*60*60) - 1000)\n\nmsg.numDays = dtEnd.getDate();\n\nvar res = []\n\nfor(var i = 1; i <= msg.numDays; i++) {\n    var t = [];\n    var dt = new Date(dtStart.getFullYear(), dtStart.getMonth(), i) //Current Day\n    var dt2 = new Date(dtStart.getFullYear(), dtStart.getMonth(), i+1) //Day after\n    t.push(Math.ceil(dt.getTime()/1000))\n    dt = new Date((dt.getTime()) + (dt2.getTime()-dt.getTime()))\n    t.push(Math.ceil(dt.getTime()/1000))\n    res.push(t)\n}\n\nmsg.eachDays = res;\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":640,"wires":[["f77d952a.aa14b8"]]},{"id":"a3f5ed00.4438d8","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.eachDays[msg.index][0] , '$lte' : msg.eachDays[msg.index][1] } };\n\nreturn msg","outputs":1,"noerr":0,"x":1400,"y":640,"wires":[["f2a73b57.2be048"]]},{"id":"f2a73b57.2be048","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"find.toArray","x":1630,"y":640,"wires":[["fc97e42f.64ce48"]]},{"id":"fc97e42f.64ce48","type":"function","z":"785b00cb.55902","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1], \"data\":[]})\n    }\n  }\n}\nmsg.currentIndex = 0\nmsg.payload = msg.event\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":640,"wires":[["a90dba30.4da598"]]},{"id":"a90dba30.4da598","type":"function","z":"785b00cb.55902","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\nvar range = 5\n\n\nfor (var i = 0; i < msg.payload.length; i++) {\n  var avg = msg.payload[i].end.average;\n  var elapsed = msg.payload[i].end.elapsed;\n  var duration = msg.payload[i].end.requiredDuration;\n  var angle = msg.payload[i].end.requiredAngle;\n  \n  var goodAngle = (avg >= angle-range && avg <= angle+range);\n  var goodTime = (elapsed >= duration);\n  \n  \n  if(goodAngle && goodTime) {\n      result[0] += 1;\n  } else if(goodAngle && !goodTime) {\n      result[1] += 1;\n  } else if(!goodAngle && goodTime) {\n      result[2] += 1;\n  } else {\n      //result[3] += 1;\n  }\n} \n\nmsg.payload = {\"calculatedTilts\":result}\n\nreturn msg;","outputs":1,"noerr":0,"x":2120,"y":640,"wires":[["d79450.139da3b"]]},{"id":"6bd78b21.dbdff4","type":"function","z":"785b00cb.55902","name":"Check index","func":"\nif(msg.index < msg.numDays-1) {\n    msg.done = false;\n} else {\n    msg.done = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2630,"y":640,"wires":[["f49981b2.f777e"]]},{"id":"f49981b2.f777e","type":"switch","z":"785b00cb.55902","name":"Is Done","property":"done","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2800,"y":580,"wires":[["bd390d91.2f07f"],["f77d952a.aa14b8"]]},{"id":"deac026a.c549d8","type":"http response","z":"785b00cb.55902","name":"","statusCode":"","headers":{},"x":3170,"y":581,"wires":[]},{"id":"bd390d91.2f07f","type":"change","z":"785b00cb.55902","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"result","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2990,"y":581,"wires":[["deac026a.c549d8","404934e5.25c01c"]]},{"id":"f2a22c8f.878008","type":"comment","z":"785b00cb.55902","name":"Info request","info":"Parameter Day and Offset\nreturn array[5], number of tilt by category\n0:Bon angle Bonne dur√©e\n1:Bon angle, dur√©e trop courte\n2:Mauvais angle, bonne duree\n3:Non r√©alis√©\n4:Snooz√©","x":533.75,"y":599.7708435058594,"wires":[]},{"id":"f430b6e3.1e42e8","type":"comment","z":"785b00cb.55902","name":"TODO","info":"Pas d'angle sous 10 degr√©, limit√© par la FSM","x":2330,"y":740,"wires":[]},{"id":"40d964ee.099f3c","type":"comment","z":"785b00cb.55902","name":"TODO","info":"Manque bascule de mauvais angle et mauvaise dur√©e\nBesoin de l'alarme pour controller le snooze et non r√©alis√©","x":2290,"y":580,"wires":[]},{"id":"d9580e25.2d0e7","type":"comment","z":"70286646.4b1c9","name":"Info request","info":"Parameter Day and Offset\nreturn un objet de timestamp\n\n{\n   \"1543410677000\":{\n      \"center\":{\n         \"x\":-0.1383751481771469,\n         \"y\":-0.29149141907691956\n      },\n      \"quadrants\":[\n         {\n            \"x\":-0.12534435093402863,\n            \"y\":-0.3292011022567749\n         },\n         {\n            \"x\":0.028964517638087273,\n            \"y\":-0.2795076072216034\n         },\n         {\n            \"x\":-0.06779661029577255,\n            \"y\":-0.023378141224384308\n         },\n         {\n            \"x\":-0.1070745661854744,\n            \"y\":0.00637348648160696\n         }\n      ]\n   }\n}","x":350,"y":200,"wires":[]},{"id":"25d05c06.e5d954","type":"mongodb2 in","z":"70286646.4b1c9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"find.toArray","x":1050,"y":240,"wires":[["72e97350.b1d7f4"]]},{"id":"f964572f.4eea18","type":"function","z":"70286646.4b1c9","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":800,"y":240,"wires":[["25d05c06.e5d954"]]},{"id":"9871374f.6c3c1","type":"function","z":"70286646.4b1c9","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day));\nmsg.start = Math.ceil((date.getTime() + msg.payload.Offset*3600000)/1000);\nmsg.end = ((msg.start + 3600*24 - 1))\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":240,"wires":[["f964572f.4eea18"]]},{"id":"fc0f7d7.4e0b38","type":"comment","z":"70286646.4b1c9","name":"TODO","info":"Pas d'angle sous 10 degr√©, limit√© par la FSM","x":1450,"y":200,"wires":[]},{"id":"72e97350.b1d7f4","type":"function","z":"70286646.4b1c9","name":"Format data","func":"var result = {}\n\nfor(var i = 0; i < msg.payload.length;i++) {\n    var e = msg.payload[i]\n    var remap = [e.Pressure.centerOfGravityPerQuadrant[3],e.Pressure.centerOfGravityPerQuadrant[0],e.Pressure.centerOfGravityPerQuadrant[1],e.Pressure.centerOfGravityPerQuadrant[2]]\n    for(var j = 0; j < 4; j++) {\n        remap[j] = {\"x\": remap[j].x/2, \"y\": remap[j].y/2}\n    }\n    result[(e.time*1000)] = {\"center\":e.Pressure.centerOfGravity, \"quadrants\":remap}\n}\nmsg.payload = result\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":240,"wires":[["82e1f7b5.443008"]]},{"id":"1c4b19d2.70fb9e","type":"http in","z":"70286646.4b1c9","name":"","url":"/gravityCenter","method":"get","upload":false,"swaggerDoc":"","x":330,"y":240,"wires":[["9871374f.6c3c1"]]},{"id":"82e1f7b5.443008","type":"http response","z":"70286646.4b1c9","name":"","statusCode":"","headers":{},"x":1450,"y":240,"wires":[]},{"id":"8ee03d78.e2bc3","type":"http in","z":"70286646.4b1c9","name":"","url":"/sittingTime","method":"get","upload":false,"swaggerDoc":"","x":320,"y":340,"wires":[["89373537.eb3c3"]]},{"id":"89373537.eb3c3","type":"function","z":"70286646.4b1c9","name":"Datestamp for whole month","func":"//En format UTC\n\nvar Day = parseInt(msg.payload.Day)\n//var Offset = parseInt(msg.payload.Offset)\n//var localOffset = (-1) * (Offset*60) * 60000;\n\n\nvar date = new Date(Day);\nvar start = new Date(date.getFullYear(), date.getMonth(), 1);\nvar end = new Date(date.getFullYear(), date.getMonth()+1, 0);\n\nmsg.start = (Math.ceil((start.getTime())/1000))\nmsg.end = ((Math.ceil((end.getTime()) + (3600000*24))/1000) - 1)\n\nreturn msg\n","outputs":1,"noerr":0,"x":560,"y":340,"wires":[["b67dd36c.90953"]]},{"id":"5c197f00.81264","type":"mongodb2 in","z":"70286646.4b1c9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingState","operation":"find.toArray","x":1330,"y":340,"wires":[["d74e294a.746858"]]},{"id":"ec50228e.3f1fc8","type":"function","z":"70286646.4b1c9","name":"EventToQuery","func":"if(msg.index === undefined) {\n    msg.index = 0;\n} else {\n    msg.index++;\n}\n\nmsg.payload = { 'time' : { '$gte' : msg.eachDays[msg.index][0] , '$lte' : msg.eachDays[msg.index][1] } };\n\nreturn msg","outputs":1,"noerr":0,"x":1070,"y":340,"wires":[["5c197f00.81264"]]},{"id":"b67dd36c.90953","type":"function","z":"70286646.4b1c9","name":"Timestamp for Each Day","func":"var dtStart = new Date(msg.start*1000);\nvar dtEnd = new Date(dtStart.getFullYear(), dtStart.getMonth()+1, 0)\ndtEnd = new Date((dtEnd.getTime()) + (24*1000*60*60) - 1000)\n\nmsg.numDays = dtEnd.getDate();\n\nvar res = []\n\nfor(var i = 1; i <= msg.numDays; i++) {\n    var t = [];\n    var dt = new Date(dtStart.getFullYear(), dtStart.getMonth(), i) //Current Day\n    var dt2 = new Date(dtStart.getFullYear(), dtStart.getMonth(), i+1) //Day after\n    t.push(Math.ceil(dt.getTime()/1000))\n    dt = new Date((dt.getTime()) + (dt2.getTime()-dt.getTime()))\n    t.push(Math.ceil(dt.getTime()/1000))\n    res.push(t)\n}\n\nmsg.eachDays = res;\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":340,"wires":[["ec50228e.3f1fc8"]]},{"id":"74124f4e.3c6108","type":"function","z":"70286646.4b1c9","name":"Check index","func":"\nif(msg.index < msg.numDays-1) {\n    msg.done = false;\n} else {\n    msg.done = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2020,"y":340,"wires":[["1357e0e8.30abef"]]},{"id":"1357e0e8.30abef","type":"switch","z":"70286646.4b1c9","name":"Is Done","property":"done","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":2190,"y":280,"wires":[["a82eda0b.c580b"],["ec50228e.3f1fc8"]]},{"id":"d74e294a.746858","type":"function","z":"70286646.4b1c9","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1], \"data\":[]})\n    }\n  }\n}\nmsg.currentIndex = 0\nmsg.payload = msg.event\nreturn msg;","outputs":1,"noerr":0,"x":1590,"y":340,"wires":[["4fa0a648.a8c07"]]},{"id":"4fa0a648.a8c07","type":"function","z":"70286646.4b1c9","name":"Create array of angles","func":"if(msg.result === undefined) {\n    msg.result = {}\n}\n\nvar sum = 0\nfor(var i = 0; i < msg.payload.length; i++) {\n    sum += msg.payload[i].end.elapsed/60\n}\n\nmsg.result[msg.index+1] = sum\n\nreturn msg;","outputs":1,"noerr":0,"x":1810,"y":340,"wires":[["74124f4e.3c6108"]]},{"id":"d2c08245.d282d","type":"http response","z":"70286646.4b1c9","name":"","statusCode":"","headers":{},"x":2580,"y":340,"wires":[]},{"id":"a82eda0b.c580b","type":"change","z":"70286646.4b1c9","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"result","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2400,"y":340,"wires":[["d2c08245.d282d","2459e5e5.25ee62"]]},{"id":"b0fbab5f.3980b","type":"comment","z":"70286646.4b1c9","name":"TODO","info":"Pas d'angle sous 10 degr√©, limit√© par la FSM","x":1760,"y":280,"wires":[]},{"id":"9e4af168.af0638","type":"debug","z":"70286646.4b1c9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2850,"y":260,"wires":[]},{"id":"2459e5e5.25ee62","type":"function","z":"70286646.4b1c9","name":"","func":"msg.payload = JSON.stringify(msg.payload)\nreturn msg;","outputs":1,"noerr":0,"x":2690,"y":260,"wires":[["9e4af168.af0638"]]},{"id":"ca013bc2.b6497","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/memory","method":"get","upload":false,"swaggerDoc":"","x":350,"y":100,"wires":[["a0be57c4.1e5888"]]},{"id":"d8483970.681f2","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":1230,"y":100,"wires":[]},{"id":"a0be57c4.1e5888","type":"exec","z":"fd561dd2.b6ea58","command":"df -h | awk 'FNR == 2 && /dev/root {print $2, $3}'","addpay":false,"append":"","useSpawn":"false","timer":"1","oldrc":false,"name":"Get Total and Used memory","x":580,"y":100,"wires":[["27da295f.8ba096"],[],[]]},{"id":"27da295f.8ba096","type":"function","z":"fd561dd2.b6ea58","name":"Format and split string","func":"var res = msg.payload.split(' ')\nmsg.capacity = parseFloat(res[0].replace(/[^\\d.-]/g, ''));\nmsg.used = parseFloat(res[1].replace(/[^\\d.-]/g, ''));\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":100,"wires":[["868e1075.e762f8"]]},{"id":"868e1075.e762f8","type":"change","z":"fd561dd2.b6ea58","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"},{"t":"set","p":"payload.total","pt":"msg","to":"capacity","tot":"msg"},{"t":"set","p":"payload.used","pt":"msg","to":"used","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":100,"wires":[["d8483970.681f2"]]},{"id":"50354145.e0d898","type":"http in","z":"28ede86e.b0dc6","name":"","url":"/dataAgreement","method":"get","upload":false,"swaggerDoc":"","x":180,"y":540,"wires":[["be0ce3bc.7efed8"]]},{"id":"9041bf22.55aa4","type":"mongodb2 in","z":"28ede86e.b0dc6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":800,"y":540,"wires":[["dacc527e.6ed3f8"]]},{"id":"e0293407.660d6","type":"function","z":"28ede86e.b0dc6","name":"Create Request","func":"var request = {\"Value\":\"DataAgreement\"};\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":540,"wires":[["9041bf22.55aa4"]]},{"id":"be0ce3bc.7efed8","type":"subflow:4e4dbcc2.17d054","z":"28ede86e.b0dc6","name":"","x":390,"y":540,"wires":[["e0293407.660d6"]]},{"id":"dacc527e.6ed3f8","type":"http response","z":"28ede86e.b0dc6","name":"","statusCode":"","headers":{},"x":990,"y":540,"wires":[]},{"id":"f9de807c.acd2e","type":"mongodb2 in","z":"28ede86e.b0dc6","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configurations","collection":"Config","operation":"update","x":1040,"y":600,"wires":[["7dd70711.4ac4d8"]]},{"id":"a7cd87ad.493f78","type":"function","z":"28ede86e.b0dc6","name":"Create Request","func":"msg.payload =[{Value:\"DataAgreement\"},{$set:msg.payload}];\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":600,"wires":[["f9de807c.acd2e"]]},{"id":"7ca0f5.5929d70c","type":"subflow:4e4dbcc2.17d054","z":"28ede86e.b0dc6","name":"","x":390,"y":600,"wires":[["f34d8c76.0b6658"]]},{"id":"7dd70711.4ac4d8","type":"http response","z":"28ede86e.b0dc6","name":"","statusCode":"","headers":{},"x":1230,"y":600,"wires":[]},{"id":"8a935947.deae78","type":"http in","z":"28ede86e.b0dc6","name":"","url":"/dataAgreement","method":"post","upload":false,"swaggerDoc":"","x":180,"y":600,"wires":[["7ca0f5.5929d70c"]]},{"id":"f34d8c76.0b6658","type":"function","z":"28ede86e.b0dc6","name":"invertDataAgreement","func":"msg.payload.dataAgreement = !msg.payload.dataAgreement\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":600,"wires":[["a7cd87ad.493f78"]]},{"id":"599cbca8.086fc4","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"8c99f6d6.ddd4d","client":"","x":530,"y":520,"wires":[]},{"id":"b0ed070c.b8b598","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"76042830.e1476","client":"","x":540,"y":280,"wires":[]},{"id":"e9e037fc.a92f18","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"c3eb9ecd.694a1","client":"","x":530,"y":180,"wires":[]},{"id":"b0013f36.edc098","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"3f158145.0b3c46","client":"","x":530,"y":80,"wires":[]},{"id":"863459d4.3ed33","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/calibrateIMU","method":"get","upload":false,"swaggerDoc":"","x":330,"y":260,"wires":[["6c6c7ba5.0b5cac","ded270f7.f52948"]]},{"id":"6c6c7ba5.0b5cac","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":510,"y":300,"wires":[]},{"id":"8123ecca.afcec","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/alert","method":"get","upload":false,"swaggerDoc":"","x":380,"y":400,"wires":[["f36d9ca8.c985f","a2355e51.be1c88"]]},{"id":"f36d9ca8.c985f","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":530,"y":420,"wires":[]},{"id":"a2355e51.be1c88","type":"function","z":"fd561dd2.b6ea58","name":"State to Int","func":"if (msg.payload.State === \"on\") {\n    msg.payload = 1\n} else {\n    msg.payload = 0\n}\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":380,"wires":[["e0ce207c.6d752"]]},{"id":"830b4a52.c322d","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/notificationSettings","method":"get","upload":false,"swaggerDoc":"","x":330,"y":500,"wires":[["cafc2f61.2f8248"]]},{"id":"98d3fdaa.e74a78","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/notificationSettings","method":"post","upload":false,"swaggerDoc":"","x":330,"y":560,"wires":[["539b152d.d4d77c"]]},{"id":"78ab2ca8.cc2464","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":970,"y":500,"wires":[]},{"id":"1f4aa3d3.5961d4","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":970,"y":560,"wires":[]},{"id":"c45af36f.2161b","type":"mongodb2 in","z":"fd561dd2.b6ea58","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configuration","collection":"Config","operation":"update","x":780,"y":560,"wires":[["1f4aa3d3.5961d4","b1fdf16c.165a2"]]},{"id":"539b152d.d4d77c","type":"function","z":"fd561dd2.b6ea58","name":"Create Request","func":"msg.payload =[{Value:\"Alarm\"},{$set:msg.req.body}];\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":560,"wires":[["c45af36f.2161b"]]},{"id":"5ffc2dd.5305554","type":"mongodb2 in","z":"fd561dd2.b6ea58","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":780,"y":500,"wires":[["78ab2ca8.cc2464"]]},{"id":"cafc2f61.2f8248","type":"function","z":"fd561dd2.b6ea58","name":"Create Request","func":"msg.payload = {\"Value\":\"Alarm\"};\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":500,"wires":[["5ffc2dd.5305554"]]},{"id":"50400557.6d576c","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/wifi","method":"get","upload":false,"swaggerDoc":"","x":280,"y":680,"wires":[["50d204e9.7fa88c"]]},{"id":"d1cfa981.10c228","type":"http in","z":"fd561dd2.b6ea58","name":"","url":"/wifi","method":"post","upload":false,"swaggerDoc":"","x":280,"y":740,"wires":[["647c800f.85c8","e2005ea9.c25978"]]},{"id":"734f0a85.ccbac4","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":750,"y":680,"wires":[]},{"id":"647c800f.85c8","type":"http response","z":"fd561dd2.b6ea58","name":"","statusCode":"","headers":{},"x":430,"y":740,"wires":[]},{"id":"50d204e9.7fa88c","type":"is online","z":"fd561dd2.b6ea58","name":"","url":"8.8.8.8","action":"0","x":440,"y":680,"wires":[["640c3242.34e634"]]},{"id":"640c3242.34e634","type":"template","z":"fd561dd2.b6ea58","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"connected\": {{payload}} }","output":"json","x":600,"y":680,"wires":[["734f0a85.ccbac4"]]},{"id":"61e834bc.357ae4","type":"http in","z":"785b00cb.55902","name":"","url":"/dailySlideProgress","method":"get","upload":false,"swaggerDoc":"","x":310,"y":1053,"wires":[["2daf328b.9dec36"]]},{"id":"674e3763.25588","type":"template","z":"785b00cb.55902","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"[{{payload.restPercent}}, {{payload.travelPercent}}]","output":"str","x":2020,"y":1040,"wires":[["39f44b61.340154"]]},{"id":"39f44b61.340154","type":"http response","z":"785b00cb.55902","name":"","statusCode":"200","headers":{},"x":2180,"y":1040,"wires":[]},{"id":"a2af5273.ee655","type":"function","z":"85ae1227.5aacf8","name":"","func":"msg.host = msg.config.telaskHost\nmsg.user = msg.config.telaskUsername\nmsg.password = msg.config.telaskKey\nvar filedata = JSON.stringify(msg.payload);\nmsg.payload = {}\nmsg.payload.filename=msg.sftpFilename;\nmsg.payload.filedata=filedata;\nmsg.payload.filedata = msg.payload.filedata.replace(/\\\\n/g, '')\nmsg.payload.filedata = msg.payload.filedata.replace(/\\\\/g, '')\nmsg.payload.filedata = (msg.payload.filedata.charAt(0) == \"\\\"\" && msg.payload.filedata.slice(-1) == \"\\\"\") ? msg.payload.filedata.substring(1, msg.payload.filedata.length-1) : msg.payload.filedata\n\nreturn msg;","outputs":1,"noerr":0,"x":3730,"y":1220,"wires":[["e2a1a59e.560e38","3578cab2.a022c6"]]},{"id":"c9a04284.08295","type":"is online","z":"85ae1227.5aacf8","name":"","url":"","action":"1","x":3580,"y":1220,"wires":[["a2af5273.ee655"]]},{"id":"419d75e3.b393dc","type":"template","z":"dc840522.071f9","name":"File rev A","field":"fileData","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\n  \"createdAt\": {{payload.createdAt}},\n  \"userId\": \"{{payload.config.userID}}\",\n  \"maxAngle\": {{payload.config.maxAngle}},\n  \"weight\": {{payload.config.userWeight}},\n  \"chairId\": \"{{payload.chairID}}\",\n  \"date\": \"{{payload.date}}\",\n  \"timezone\": {{payload.timezone}},\n  \"minAngle\": {{payload.config.minAngle}},\n  \"rev\": \"A\",\n  \"tilt\": {\n    \"distribution\": {\n      \"index\": [\n        \"Less than 0¬∞\",\n        \"0¬∞ to 15¬∞\",\n        \"0¬∞ to 30¬∞\",\n        \"30¬∞ to 45¬∞\",\n        \"More than 45¬∞\"\n      ],\n      \"duration_ms\": [{{payload.distributionData}}]\n    },\n    \"tiltCount\": {\n      \"index\": [\n        \"Good angle and duration\",\n        \"Good angle but insufficient duration\",\n        \"Wrong angle but good duration\",\n        \"Cancelled tilt\",\n        \"Snoozed tilt\"\n      ],\n      \"count\": [{{payload.numTilt}}]\n    },\n    \"slidingTravelGoalPercent\": {{payload.slideProgress.0}},\n    \"slidingRestGoalPercent\": {{payload.slideProgress.1}}\n  },\n  \"pressure\": {\n    \"relievePressureGoalPercent\": {{payload.pressureProgress.0}},\n    \"releivePressurePersonalGoalPercent\": {{payload.pressureProgress.1}},\n    \"byTimestamp\": {  }\n  }\n}","output":"str","x":2660,"y":780,"wires":[["b8f0ca7c.103548"]]},{"id":"f51003a2.6c3108","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":1830,"y":840,"wires":[["7f6d9541.86158c"]]},{"id":"b94dd1c5.4336f","type":"function","z":"dc840522.071f9","name":"Create Request","func":"var request = [{\"Value\":\"Configuration\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":1600,"y":840,"wires":[["f51003a2.6c3108"]]},{"id":"71f29658.95497","type":"comment","z":"dc840522.071f9","name":"Configuration parameter","info":"","x":2010,"y":800,"wires":[]},{"id":"19ef0a13.4002d6","type":"function","z":"dc840522.071f9","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1100,"y":1078,"wires":[["d5548808.f2edf8"]]},{"id":"91a2a093.0257a","type":"function","z":"dc840522.071f9","name":"CreateEventPair","func":"var i;\nmsg.event = [];\nfor (i = 0; i < msg.payload.length; i+=2) {\n  if (msg.payload[i+1] !== undefined) {\n    if(msg.payload[i].state == 'Started' && msg.payload[i+1].state == 'Stopped') {\n          msg.event.push({\"begin\":msg.payload[i], \"end\":msg.payload[i+1], \"data\":[]})\n    }\n  }\n}\nmsg.currentIndex = 0\nreturn msg;","outputs":1,"noerr":0,"x":1580,"y":1078,"wires":[["8f2602ab.d3dce"]]},{"id":"8f2602ab.d3dce","type":"change","z":"dc840522.071f9","name":"","rules":[{"t":"move","p":"event","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":1078,"wires":[["9962a2fd.5a522","a4b5141a.014188"]]},{"id":"d5548808.f2edf8","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"find.toArray","x":1340,"y":1078,"wires":[["91a2a093.0257a"]]},{"id":"9962a2fd.5a522","type":"function","z":"dc840522.071f9","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\nvar range = 2\n\n\nfor (var i = 0; i < msg.payload.length; i++) {\n  var avg = msg.payload[i].end.average;\n  var elapsed = msg.payload[i].end.elapsed;\n  var duration = msg.payload[i].end.requiredDuration;\n  var angle = msg.payload[i].end.requiredAngle;\n  \n  var goodAngle = (avg >= angle-range && duration <= angle-range);\n  var goodTime = (elapsed >= duration);\n  \n  \n  if(goodAngle && goodTime) {\n      result[0] += 1;\n  } else if(goodAngle && !goodTime) {\n      result[1] += 1;\n  } else if(!goodAngle && goodTime) {\n      result[2] += 1;\n  } else {\n      result[3] += 1;\n  }\n} \n\nmsg.payload = {\"numTilt\": result}\n\nreturn msg;","outputs":1,"noerr":0,"x":2010,"y":1040,"wires":[["45f634dd.b4c884"]]},{"id":"beb10a22.160e28","type":"comment","z":"dc840522.071f9","name":"Distribution Array","info":"","x":2028,"y":1080,"wires":[]},{"id":"a4b5141a.014188","type":"function","z":"dc840522.071f9","name":"Create array of angles","func":"\nvar result = [0,0,0,0,0]\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    result[0] += msg.payload[i].end.lessThanZero*1000;\n    result[1] += msg.payload[i].end.zeroToFifteen*1000;\n    result[2] += msg.payload[i].end.fifteenToThirty*1000;\n    result[3] += msg.payload[i].end.thirtyToFourtyfive*1000;\n    result[4] += msg.payload[i].end.fourtyfiveAndMore*1000;\n} \nmsg.payload = {\"distributionData\": result}\n\nreturn msg;","outputs":1,"noerr":0,"x":2006,"y":1120,"wires":[["45f634dd.b4c884"]]},{"id":"2540fa5.ff33c06","type":"comment","z":"dc840522.071f9","name":"Number of tilt Array","info":"","x":2030,"y":1000,"wires":[]},{"id":"fa87dce5.c870b8","type":"comment","z":"dc840522.071f9","name":"Slide progress","info":"","x":2040,"y":540,"wires":[]},{"id":"10acd2a7.9ba435","type":"template","z":"dc840522.071f9","name":"Fake relieve pressure data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"pressureProgress\":[0, 0]}","output":"json","x":1780,"y":740,"wires":[["253525b6.5dce2a"]]},{"id":"84b313e5.9cd398","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"find.toArray","x":1806,"y":940,"wires":[["cd615774.b8f0f8"]]},{"id":"ca257ef7.cfe29","type":"function","z":"dc840522.071f9","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1556,"y":940,"wires":[["84b313e5.9cd398"]]},{"id":"31f5a36c.c98c24","type":"function","z":"dc840522.071f9","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day))\nmsg.start = parseInt(date.setHours(0,0,0,0)/1000)\nmsg.end = parseInt(date.setHours(23,59,59,999)/1000)\nreturn msg","outputs":1,"noerr":0,"x":1326,"y":940,"wires":[["ca257ef7.cfe29"]]},{"id":"cd615774.b8f0f8","type":"function","z":"dc840522.071f9","name":"Format data","func":"var result = {}\nvar arr = {\"x\":[], \"y\":[]}\n\nfor(var i = 0; i < msg.payload.length;i++) {\n    var e = msg.payload[i]\n    var remap = [e.Pressure.centerOfGravityPerQuadrant[3],e.Pressure.centerOfGravityPerQuadrant[0],e.Pressure.centerOfGravityPerQuadrant[1],e.Pressure.centerOfGravityPerQuadrant[2]]\n    for(var j = 0; j < 4; j++) {\n        arr.x.push(remap[j].x/2)\n        arr.y.push(remap[j].y/2)\n    }\n    result[(e.time*1000)] = {\"center\":e.Pressure.centerOfGravity, \"quadrants\":arr, \"angle\":e.angle}\n    arr = {\"x\":[], \"y\":[]}\n}\nmsg.payload = {\"pressureData\": result}\nreturn msg;","outputs":1,"noerr":0,"x":2046,"y":940,"wires":[["45f634dd.b4c884"]]},{"id":"45f634dd.b4c884","type":"join","z":"dc840522.071f9","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"14","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2310,"y":780,"wires":[["9b2ff79b.32e5a8"]]},{"id":"3591623e.bdeb46","type":"comment","z":"dc840522.071f9","name":"Relieve pressure progress","info":"","x":2000,"y":700,"wires":[]},{"id":"7f6d9541.86158c","type":"change","z":"dc840522.071f9","name":"","rules":[{"t":"delete","p":"payload.Value","pt":"msg"},{"t":"delete","p":"payload._id","pt":"msg"},{"t":"move","p":"payload","pt":"msg","to":"payload.config","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2040,"y":840,"wires":[["45f634dd.b4c884"]]},{"id":"2b5c31fd.d8a32e","type":"comment","z":"dc840522.071f9","name":"Pressure Data","info":"","x":2040,"y":900,"wires":[]},{"id":"cc8343ac.b4794","type":"exec","z":"dc840522.071f9","command":"/home/pi/MOvIT-Detect-Backend/scripts/getAPName.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1710,"y":480,"wires":[["9e4f6301.e6de7"],[],[]]},{"id":"9e4f6301.e6de7","type":"function","z":"dc840522.071f9","name":"Keep chairID only","func":"msg.payload = msg.payload.substr(-6);\nmsg.payload = {\"chairID\":msg.payload.substr(-6)}\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":480,"wires":[["45f634dd.b4c884"]]},{"id":"b8f0ca7c.103548","type":"change","z":"dc840522.071f9","name":"Add pressure data, move payload","rules":[{"t":"move","p":"payload.pressureData","pt":"msg","to":"fileData.pressure.byTimestamp","tot":"msg"},{"t":"move","p":"payload.config.telaskHost","pt":"msg","to":"telaskHost","tot":"msg"},{"t":"move","p":"payload.config.telaskKey","pt":"msg","to":"telaskKey","tot":"msg"},{"t":"move","p":"payload.config.telaskUsername","pt":"msg","to":"telaskUsername","tot":"msg"},{"t":"move","p":"fileData","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2900,"y":780,"wires":[[]]},{"id":"9b2ff79b.32e5a8","type":"template","z":"dc840522.071f9","name":"Create file Name","field":"originalName","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"MOVIT+_{{payload.config.userID}}_{{payload.chairID}}_{{payload.date}}.json","output":"str","x":2480,"y":780,"wires":[["419d75e3.b393dc"]]},{"id":"2f80af88.cbc25","type":"function","z":"dc840522.071f9","name":"Convert to percent","func":"msg.payload.slideProgress = []\nmsg.payload.slideProgress[0] = msg.payload.restPercent * 100.0\nmsg.payload.slideProgress[1] = msg.payload.travelPercent * 100.0\nreturn msg;","outputs":1,"noerr":0,"x":2028,"y":580,"wires":[["45f634dd.b4c884"]]},{"id":"253525b6.5dce2a","type":"function","z":"dc840522.071f9","name":"Convert to percent","func":"msg.payload.pressureProgress[0] *= 100.0\nmsg.payload.pressureProgress[1] *= 100.0\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":740,"wires":[["45f634dd.b4c884"]]},{"id":"3fd9bd41.6f8fb2","type":"function","z":"dc840522.071f9","name":"Check if in the past","func":"var actualDay = new Date(parseInt(msg.payload.Day))\nvar now = new Date()\nmsg.payload.dayStart = actualDay.setHours(0,0,0,0)\nmsg.payload.dayEnd = actualDay.setHours(23,59,59,999)\nmsg.payload.inThePast = ((msg.payload.dayStart - now.getTime()) < 0 && (msg.payload.dayEnd - now.getTime()) < 0)\n\nif (msg.payload.inThePast) {\n    return msg;   \n}","outputs":1,"noerr":0,"x":330,"y":860,"wires":[["31f5a36c.c98c24","b94dd1c5.4336f","10acd2a7.9ba435","cc8343ac.b4794","4f6705a5.f3375c","d1888bb4.c4d3f8","717d7362.6b40ac"]]},{"id":"de08ef64.cc3dc","type":"subflow:dc840522.071f9","z":"85ae1227.5aacf8","name":"","x":2080,"y":1100,"wires":[["45cf19f.328a668"]]},{"id":"b65e898a.ad5d5","type":"function","z":"85ae1227.5aacf8","name":"Time status","func":"var actualDay = new Date(parseInt(msg.payload.Day))\nvar now = new Date()\nmsg.payload.dayStart = actualDay.setHours(0,0,0,0)\nmsg.payload.dayEnd = actualDay.setHours(23,59,59,999)\nmsg.payload.inThePast = ((msg.payload.dayStart - now.getTime()) < 0 && (msg.payload.dayEnd - now.getTime()) < 0)\n\nif(msg.payload.inThePast) {\n    node.status({fill:\"green\",shape:\"dot\",text:\"In the Past\"});\n} else {\n    node.status({fill:\"red\",shape:\"dot\",text:\"In the Future\"});\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":1100,"wires":[["de08ef64.cc3dc"]]},{"id":"45cf19f.328a668","type":"template","z":"85ae1227.5aacf8","name":"","field":"filename","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"/home/pi/MOvIT-Detect-Backend/JSONReport/{{originalName}}","output":"str","x":2280,"y":1100,"wires":[["2bf613ca.f9957c"]]},{"id":"2bf613ca.f9957c","type":"file","z":"85ae1227.5aacf8","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","x":2430,"y":1100,"wires":[["209586f0.6fdb1a"]]},{"id":"4f6705a5.f3375c","type":"function","z":"dc840522.071f9","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day))\nmsg.start = parseInt(date.setHours(0,0,0,0)/1000)\nmsg.end = parseInt(date.setHours(23,59,59,999)/1000)\nreturn msg","outputs":1,"noerr":0,"x":870,"y":1080,"wires":[["19ef0a13.4002d6"]]},{"id":"2e8a58e6.2f3","type":"function","z":"85ae1227.5aacf8","name":"Get each day since creation","func":"var arr = []\n\nvar date = new Date(parseInt(msg.payload.time*1000))\nvar now = new Date();\n\nfor(var i = 0; !isToday(now, date); i++) {\n    \n    arr.push(date.getTime()/1000);\n    date.setDate(date.getDate() + 1)\n}\n//From most recent to oldest\nmsg.allDays = arr.sort().reverse()\nmsg.payload = {\"sent\":true}\nreturn msg;\n\n\nfunction isToday(now, toCompare) {\n    return (now.setHours(0,0,0,0) == toCompare.setHours(0,0,0,0))\n}","outputs":1,"noerr":0,"x":860,"y":1100,"wires":[["82de47e4.06f01"]]},{"id":"5ce3c6ba.509ed","type":"inject","z":"85ae1227.5aacf8","name":"Create files every hour","topic":"","payload":"{}","payloadType":"json","repeat":"3600","crontab":"","once":true,"onceDelay":0.1,"x":210,"y":920,"wires":[["5edccaf2.f2c8d4"]]},{"id":"c3bc5603.03f158","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"findOne","x":580,"y":1100,"wires":[["2e8a58e6.2f3"]]},{"id":"82de47e4.06f01","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"FileReport","operation":"find.toArray","x":1140,"y":1100,"wires":[["23f94b8f.4b73bc"]]},{"id":"209586f0.6fdb1a","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"[{ \"time\":{{day}}}, {\"$set\": {\"filename\":\"{{originalName}}\", \"sent\":false} }, {\"upsert\":true}]","output":"json","x":2580,"y":1100,"wires":[["2169e91d.80270e"]]},{"id":"23f94b8f.4b73bc","type":"function","z":"85ae1227.5aacf8","name":"Remove days already created","func":"Array.prototype.diff = function(a) {\n    return this.filter(function(i) {return a.indexOf(i) < 0;});\n};\n\nvar bdDays = []\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    bdDays.push(msg.payload[i].time)\n}\n\n\nmsg.daysToSend = bdDays.filter( function( el ) {\n  return !Array.from(msg.allDays).includes( el );\n} );\n\na = Array.from(msg.allDays)\nmsg.bd = bdDays\nmsg.daysToSend = a.diff(msg.bd)\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1100,"wires":[["a48c39c1.ae1d48"]]},{"id":"2169e91d.80270e","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"FileReport","operation":"update","x":2770,"y":1100,"wires":[["6e2dc76f.23c0f","595af030.592e28"]]},{"id":"a48c39c1.ae1d48","type":"function","z":"85ae1227.5aacf8","name":"if days to send","func":"if(msg.daysToSend.length > 0) {\n    msg.payload.Day = msg.daysToSend[0] * 1000\n    msg.day = msg.daysToSend[0]\n    node.status({fill:\"green\",shape:\"dot\",text:\"Sending\"})\n    return [msg, null];\n}\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Nothing to send\"})\nreturn [null, msg]","outputs":2,"noerr":0,"x":1680,"y":1100,"wires":[["b65e898a.ad5d5"],["61df483c.211978","8091a649.12f08"]]},{"id":"6e2dc76f.23c0f","type":"function","z":"85ae1227.5aacf8","name":"Shift day","func":"msg.daysToSend.shift()\nreturn msg;","outputs":1,"noerr":0,"x":2980,"y":1100,"wires":[["a48c39c1.ae1d48"]]},{"id":"e9027b00.36ef88","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"FileReport","operation":"find.toArray","x":2560,"y":1220,"wires":[["ed876e16.db1fc"]]},{"id":"b688cbf9.2596b","type":"function","z":"85ae1227.5aacf8","name":"if files to send","func":"if(msg.bdData.length > 0) {\n    msg.originalFilename = msg.bdData[0].filename\n    msg.piFilename = \"/home/pi/MOvIT-Detect-Backend/JSONReport/\"+msg.bdData[0].filename\n    msg.sftpFilename = \"./Inbox/\"+msg.bdData[0].filename\n    msg.time = msg.bdData[0].time\n    msg._id = msg.bdData[0]._id\n    node.status({fill:\"green\",shape:\"dot\",text:\"Sending\"})\n    return [msg, null];\n}\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Nothing to send\"})\nreturn [null, msg]","outputs":2,"noerr":0,"x":3020,"y":1220,"wires":[["625f78ec.9ac1d"],["dc3c5296.b411e8"]]},{"id":"32444dcb.5af62a","type":"function","z":"85ae1227.5aacf8","name":"Shift day","func":"msg.bdData.shift()\nreturn msg;","outputs":1,"noerr":0,"x":4760,"y":1220,"wires":[["b688cbf9.2596b"]]},{"id":"ce127d07.d81a6","type":"file in","z":"85ae1227.5aacf8","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"x":3430,"y":1220,"wires":[["c9a04284.08295"]]},{"id":"625f78ec.9ac1d","type":"change","z":"85ae1227.5aacf8","name":"","rules":[{"t":"move","p":"piFilename","pt":"msg","to":"filename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3240,"y":1220,"wires":[["ce127d07.d81a6"]]},{"id":"ed876e16.db1fc","type":"change","z":"85ae1227.5aacf8","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"bdData","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2810,"y":1220,"wires":[["b688cbf9.2596b"]]},{"id":"b5543fe5.e342a","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":2100,"y":1220,"wires":[["d64508ce.fab2b8"]]},{"id":"8091a649.12f08","type":"function","z":"85ae1227.5aacf8","name":"Create Request","func":"var request = [{\"Value\":\"Configuration\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":1880,"y":1220,"wires":[["b5543fe5.e342a"]]},{"id":"d64508ce.fab2b8","type":"change","z":"85ae1227.5aacf8","name":"","rules":[{"t":"delete","p":"payload.Value","pt":"msg"},{"t":"delete","p":"payload._id","pt":"msg"},{"t":"move","p":"payload","pt":"msg","to":"config","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"{\"sent\":false}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2320,"y":1220,"wires":[["e9027b00.36ef88"]]},{"id":"3578cab2.a022c6","type":"sftp in","z":"85ae1227.5aacf8","sftp":"df33e3dc.47d9","operation":"put","filename":"","localFilename":"","fileContents":"","fileExtension":".json","workdir":"","savedir":"","name":"","x":3870,"y":1220,"wires":[["844eb0a0.522bb8"]]},{"id":"dc3c5296.b411e8","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sent complete!","output":"str","x":3200,"y":1280,"wires":[["ace5e1c5.f15e2"]]},{"id":"61df483c.211978","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"File creation complete!","output":"str","x":1860,"y":1160,"wires":[["ef14dcde.25237"]]},{"id":"397fa748.47c708","type":"file","z":"85ae1227.5aacf8","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"delete","x":4170,"y":1220,"wires":[["f5f64bbb.97a89"]]},{"id":"f5f64bbb.97a89","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"[{ \"filename\":\"{{originalFilename}}\" }, { \"$set\": {\"sent\":true} }]","output":"json","x":4320,"y":1220,"wires":[["225c2dcf.469e12"]]},{"id":"225c2dcf.469e12","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"FileReport","operation":"updateOne","x":4540,"y":1220,"wires":[["32444dcb.5af62a","9516e6ba.e16bd"]]},{"id":"844eb0a0.522bb8","type":"template","z":"85ae1227.5aacf8","name":"","field":"filename","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"/home/pi/MOvIT-Detect-Backend/JSONReport/{{originalFilename}}","output":"str","x":4020,"y":1220,"wires":[["397fa748.47c708"]]},{"id":"595af030.592e28","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Created file: {{originalName}}","output":"str","x":2980,"y":1060,"wires":[["2da93967.40576e"]]},{"id":"9516e6ba.e16bd","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sent file: {{originalFilename}}","output":"str","x":4560,"y":1140,"wires":[["16081418.b3579c"]]},{"id":"c26f2af7.d84168","type":"mongodb2 in","z":"85ae1227.5aacf8","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":200,"y":1040,"wires":[["814f177c.484558"]]},{"id":"5edccaf2.f2c8d4","type":"function","z":"85ae1227.5aacf8","name":"Create Request","func":"var request = {\"Value\":\"DataAgreement\"};\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":980,"wires":[["c26f2af7.d84168"]]},{"id":"814f177c.484558","type":"switch","z":"85ae1227.5aacf8","name":"","property":"payload.dataAgreement","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":1100,"wires":[["4d752316.2201c4"],["5bd307b4.fcf57"]]},{"id":"5bd307b4.fcf57","type":"template","z":"85ae1227.5aacf8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Data agreement denied","output":"str","x":400,"y":1160,"wires":[["7ba5c45e.b81e74"]]},{"id":"4d752316.2201c4","type":"function","z":"85ae1227.5aacf8","name":"","func":"msg.payload = {}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1100,"wires":[["c3bc5603.03f158"]]},{"id":"58be449.c4b3d3c","type":"mongodb2 in","z":"fd561dd2.b6ea58","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":1220,"y":620,"wires":[["59c7e185.364d"]]},{"id":"b1fdf16c.165a2","type":"function","z":"fd561dd2.b6ea58","name":"Create Request","func":"msg.payload = {\"Value\":\"Alarm\"};\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":620,"wires":[["58be449.c4b3d3c"]]},{"id":"59c7e185.364d","type":"function","z":"fd561dd2.b6ea58","name":"Format data","func":"msg.payload = (msg.payload.isLedBlinkingEnabled ? 1 : 0)+\":\"+(msg.payload.isVibrationEnabled ? 1 : 0)+\":\"+msg.payload.snoozeTime+\":\"+(msg.payload.enabled ? 1 : 0)\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":620,"wires":[["3337fe44.c4aed2"]]},{"id":"3337fe44.c4aed2","type":"mqtt out","z":"fd561dd2.b6ea58","name":"","topic":"config/notifications_settings","qos":"","retain":"","broker":"2b8661c7.194ede","x":1660,"y":620,"wires":[]},{"id":"5fef4a34.727ad4","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":500,"y":480,"wires":[["439aece5.e59b0c"]]},{"id":"bd051866.20fcc","type":"function","z":"e1a9ea8c.adf12","name":"","func":"var request = [{\"Value\":\"Goal\"},{}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":480,"wires":[["5fef4a34.727ad4"]]},{"id":"439aece5.e59b0c","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload.tiltFrequency}}:{{payload.tiltLength}}:{{payload.tiltAngle}}","output":"str","x":660,"y":480,"wires":[["b67e40f9.b816c"]]},{"id":"b67e40f9.b816c","type":"mqtt out","z":"e1a9ea8c.adf12","name":"","topic":"goal/update_data","qos":"","retain":"","broker":"2b8661c7.194ede","x":850,"y":480,"wires":[]},{"id":"6e0eb669.362408","type":"mqtt out","z":"e1a9ea8c.adf12","name":"","topic":"config/calib_imu_offset","qos":"1","retain":"","broker":"2b8661c7.194ede","x":1010,"y":540,"wires":[]},{"id":"7f68c3de.8a3de4","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload.mIMU}}:{{payload.fIMU}}","output":"str","x":800,"y":540,"wires":[["6e0eb669.362408"]]},{"id":"6a19515a.0ff3b8","type":"mqtt in","z":"e1a9ea8c.adf12","name":"","topic":"status","qos":"1","broker":"2b8661c7.194ede","x":150,"y":640,"wires":[["55f69b9e.975784","62d51414.62f9ec","bd051866.20fcc","75e539e1.ba2c48","452ca588.6bc3dc","8b81bb81.704998","77b13227.b3f2ac","4fc81347.8e4834"]]},{"id":"55f69b9e.975784","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sending saved parameter","output":"str","x":360,"y":620,"wires":[["832f94e.0c0f4e8"]]},{"id":"1121d4a8.ac678b","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":600,"y":540,"wires":[["7f68c3de.8a3de4"]]},{"id":"62d51414.62f9ec","type":"function","z":"e1a9ea8c.adf12","name":"Create Request","func":"msg.payload = [{\"Value\":\"AngleOffset\"},{}];\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":540,"wires":[["1121d4a8.ac678b"]]},{"id":"5aab7cff.cb5424","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"config/angle_new_offset","qos":"0","broker":"2b8661c7.194ede","x":290,"y":800,"wires":[["15d177c4.296768"]]},{"id":"c4934423.b13c6","type":"mqtt out","z":"fd561dd2.b6ea58","name":"","topic":"config/calib_imu","qos":"","retain":"","broker":"2b8661c7.194ede","x":700,"y":260,"wires":[]},{"id":"ded270f7.f52948","type":"template","z":"fd561dd2.b6ea58","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"1","output":"str","x":520,"y":260,"wires":[["c4934423.b13c6"]]},{"id":"cf672bd.cc4d458","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configuration","collection":"Config","operation":"update","x":880,"y":800,"wires":[[]]},{"id":"8c3278cb.8ebab8","type":"function","z":"d8422fcd.8b4f88","name":"Create Request","func":"var request = [{\"Value\":\"AngleOffset\"},{\"$set\":{\"mIMU\":msg.payload.mIMUOffset, \"fIMU\":msg.payload.fIMUOffset}}, {\"upsert\":true}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":800,"wires":[["cf672bd.cc4d458"]]},{"id":"15d177c4.296768","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":800,"wires":[["8c3278cb.8ebab8"]]},{"id":"d4e19681.70359","type":"mongodb2 in","z":"fd561dd2.b6ea58","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configuration","collection":"Config","operation":"update","x":960,"y":380,"wires":[["f28389a8.19023"]]},{"id":"e0ce207c.6d752","type":"function","z":"fd561dd2.b6ea58","name":"Create Request","func":"msg.payload =[{Value:\"Alarm\"},{$set:{\"enabled\":msg.payload}}];\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":380,"wires":[["d4e19681.70359"]]},{"id":"57af9764.591fa8","type":"mqtt in","z":"d8422fcd.8b4f88","name":"","topic":"fsm/notification","qos":"2","broker":"2b8661c7.194ede","x":320,"y":460,"wires":[["d761a4be.7ce2f","efa373e7.7710a"]]},{"id":"d761a4be.7ce2f","type":"websocket out","z":"d8422fcd.8b4f88","name":"","server":"71f6ec46.a70074","client":"","x":550,"y":400,"wires":[]},{"id":"d5af29cb.d65de8","type":"switch","z":"d8422fcd.8b4f88","name":"","property":"payload.event","propertyType":"msg","rules":[{"t":"neq","v":"Other","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":630,"y":460,"wires":[["f53e2538.14c42"]]},{"id":"efa373e7.7710a","type":"json","z":"d8422fcd.8b4f88","name":"","property":"payload","action":"","pretty":false,"x":490,"y":460,"wires":[["d5af29cb.d65de8"]]},{"id":"f53e2538.14c42","type":"change","z":"d8422fcd.8b4f88","name":"","rules":[{"t":"delete","p":"payload.stateNum","pt":"msg"},{"t":"delete","p":"payload.stateName","pt":"msg"},{"t":"move","p":"payload.event","pt":"msg","to":"payload.state","tot":"msg"},{"t":"delete","p":"payload.event","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":460,"wires":[["b96f6220.e42fa"]]},{"id":"b96f6220.e42fa","type":"mongodb2 in","z":"d8422fcd.8b4f88","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"NotificationState","operation":"insertOne","x":1060,"y":460,"wires":[[]]},{"id":"1aa1ef25.435389","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Count cancelled tilt","collection":"NotificationState","operation":"count","x":1370,"y":300,"wires":[["d2602ddb.36f1"]]},{"id":"1d7f76d4.946131","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = {\n              \"$and\": [\n                {\n                  \"time\": {\n                    \"$gte\": msg.start,\n                    \"$lte\": msg.end\n                  }\n                },\n                {\n                  \"$or\": [\n                    {\n                      \"state\": \"USER_DISABLED\"\n                    },\n                    {\n                      \"state\": \"NOT_SEATED\"\n                    }\n                  ]\n                }\n              ]\n            }\nreturn msg","outputs":1,"noerr":0,"x":1160,"y":300,"wires":[["1aa1ef25.435389"]]},{"id":"9db20ff4.98bf58","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Count snoozed tilt","collection":"NotificationState","operation":"count","x":1370,"y":360,"wires":[["23f9917c.22405e"]]},{"id":"9bfd46bb.6c83a8","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = {\n              \"$and\": [\n                {\n                  \"time\": {\n                    \"$gte\": msg.start,\n                    \"$lte\": msg.end\n                  }\n                },\n                {\n                  \"state\": \"SNOOZED_REQUESTED\"\n                }\n              ]\n            }\nreturn msg","outputs":1,"noerr":0,"x":1160,"y":360,"wires":[["9db20ff4.98bf58"]]},{"id":"af76bb9f.943848","type":"join","z":"785b00cb.55902","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2250,"y":300,"wires":[["c19b960d.631598"]]},{"id":"d2602ddb.36f1","type":"template","z":"785b00cb.55902","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"cancelledTilts\":{{payload}} }","output":"json","x":1560,"y":300,"wires":[["af76bb9f.943848"]]},{"id":"23f9917c.22405e","type":"template","z":"785b00cb.55902","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"snoozedTilts\":{{payload}} }","output":"json","x":1560,"y":360,"wires":[["af76bb9f.943848"]]},{"id":"c19b960d.631598","type":"function","z":"785b00cb.55902","name":"Merge","func":"msg.payload.calculatedTilts[3] += msg.payload.cancelledTilts\nmsg.payload.calculatedTilts[4] += msg.payload.snoozedTilts\nmsg.payload = msg.payload.calculatedTilts\nreturn msg;","outputs":1,"noerr":0,"x":2390,"y":300,"wires":[["29f2ac7c.f4e9a4"]]},{"id":"425489e1.bf074","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Count cancelled tilt","collection":"NotificationState","operation":"count","x":1970,"y":680,"wires":[["e7d8394.a8118c8"]]},{"id":"8b5b6250.1c58f8","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = {\n              \"$and\": [\n                {\n                  \"time\": {\n                    \"$gte\": msg.eachDays[msg.index][0],\n                    \"$lte\": msg.eachDays[msg.index][1]\n                  }\n                },\n                {\n                  \"$or\": [\n                    {\n                      \"state\": \"USER_DISABLED\"\n                    },\n                    {\n                      \"state\": \"NOT_SEATED\"\n                    }\n                  ]\n                }\n              ]\n            }\nreturn msg","outputs":1,"noerr":0,"x":1400,"y":680,"wires":[["425489e1.bf074"]]},{"id":"56ead6ed.0a5368","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Count snoozed tilt","collection":"NotificationState","operation":"count","x":1970,"y":720,"wires":[["631c74c5.740664"]]},{"id":"f1ed286e.c29718","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = {\n              \"$and\": [\n                {\n                  \"time\": {\n                    \"$gte\": msg.eachDays[msg.index][0],\n                    \"$lte\": msg.eachDays[msg.index][1]\n                  }\n                },\n                {\n                  \"state\": \"SNOOZED_REQUESTED\"\n                }\n              ]\n            }\nreturn msg","outputs":1,"noerr":0,"x":1400,"y":720,"wires":[["56ead6ed.0a5368"]]},{"id":"e7d8394.a8118c8","type":"template","z":"785b00cb.55902","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"cancelledTilts\":{{payload}} }","output":"json","x":2160,"y":680,"wires":[["d79450.139da3b"]]},{"id":"631c74c5.740664","type":"template","z":"785b00cb.55902","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"snoozedTilts\":{{payload}} }","output":"json","x":2160,"y":720,"wires":[["d79450.139da3b"]]},{"id":"f77d952a.aa14b8","type":"function","z":"785b00cb.55902","name":"buffer","func":"if(msg.index === undefined) {\n    msg.index = 0;\n    msg.result = {}\n} else {\n    msg.index++;\n}\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":640,"wires":[["a3f5ed00.4438d8","8b5b6250.1c58f8","f1ed286e.c29718"]]},{"id":"d79450.139da3b","type":"join","z":"785b00cb.55902","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2330,"y":640,"wires":[["bd601bb0.06919"]]},{"id":"bd601bb0.06919","type":"function","z":"785b00cb.55902","name":"Merge","func":"msg.payload.calculatedTilts[3] += msg.payload.cancelledTilts\nmsg.payload.calculatedTilts[4] += msg.payload.snoozedTilts\nmsg.result[msg.index+1] = msg.payload.calculatedTilts\nreturn msg;","outputs":1,"noerr":0,"x":2470,"y":640,"wires":[["6bd78b21.dbdff4"]]},{"id":"404934e5.25c01c","type":"debug","z":"785b00cb.55902","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":3190,"y":540,"wires":[]},{"id":"464a69a8.0abe08","type":"debug","z":"785b00cb.55902","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":2760,"y":740,"wires":[]},{"id":"d1888bb4.c4d3f8","type":"function","z":"dc840522.071f9","name":"Date data","func":"var payload = {}\n\nvar now = new Date();\npayload.createdAt = parseInt(now.getTime()/1000);\npayload.timezone = now.getTimezoneOffset()/-60;\n\nvar actualDay = new Date(parseInt(msg.payload.Day))\npayload.date = actualDay.toJSON().slice(0,10).split(\"-\").join('')\npayload.dayStart = actualDay.setHours(0,0,0,0)\npayload.dayEnd = actualDay.setHours(23,59,59,999)\n\n\nmsg.payload = payload\nreturn msg;","outputs":1,"noerr":0,"x":2060,"y":640,"wires":[["45f634dd.b4c884"]]},{"id":"9e45de5.6c54b2","type":"debug","z":"fd561dd2.b6ea58","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1070,"y":780,"wires":[]},{"id":"8959e0ff.e34d68","type":"exec","z":"fd561dd2.b6ea58","command":"/home/pi/MOvIT-Detect-Backend/scripts/connectToWifi.sh","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":770,"y":780,"wires":[["9e45de5.6c54b2"],["9e45de5.6c54b2"],["9e45de5.6c54b2"]]},{"id":"e2005ea9.c25978","type":"function","z":"fd561dd2.b6ea58","name":"format payload","func":"if (msg.payload.password.length >= 8) {\n    msg.payload = \"\\\"\"+msg.payload.wifi+\"\\\" \\\"\"+msg.payload.password+\"\\\"\"\n    return msg;\n}\n","outputs":1,"noerr":0,"x":460,"y":780,"wires":[["8959e0ff.e34d68"]]},{"id":"49a94fe8.b5c2f","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingState","operation":"findOne","x":580,"y":800,"wires":[["2feac668.c2fd6a"]]},{"id":"75e539e1.ba2c48","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"$query\":{}, \"$orderby\":{\"_id\":-1}}","output":"json","x":360,"y":800,"wires":[["49a94fe8.b5c2f"]]},{"id":"2feac668.c2fd6a","type":"switch","z":"e1a9ea8c.adf12","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":790,"y":800,"wires":[["c8cae431.92d66"]]},{"id":"c8cae431.92d66","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"time\": { \"$gte\": {{payload.time}} } }","output":"json","x":940,"y":800,"wires":[["d5b6d2ca.70f83"]]},{"id":"d5b6d2ca.70f83","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"find.toArray","x":1170,"y":800,"wires":[["342255c7.1eeaf2"]]},{"id":"342255c7.1eeaf2","type":"function","z":"e1a9ea8c.adf12","name":"","func":"var retObj = {};\n\nretObj.time = msg.payload[msg.payload.length - 1].time\nretObj.elapsed = msg.payload[msg.payload.length - 1].time - msg.payload[0].time\nretObj.state = \"Stopped\"\n\nmsg.payload = retObj\n\nreturn msg;","outputs":1,"noerr":0,"x":1390,"y":800,"wires":[["84597982.907218"]]},{"id":"84597982.907218","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingState","operation":"insertOne","x":1610,"y":800,"wires":[["1ec6a8fc.b5268f"]]},{"id":"6e2bbf33.7fbe4","type":"comment","z":"e1a9ea8c.adf12","name":"Close seatingState","info":"","x":390,"y":760,"wires":[]},{"id":"2b757fa3.aedb3","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"findOne","x":570,"y":880,"wires":[["e759402f.c58ef"]]},{"id":"452ca588.6bc3dc","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"$query\":{}, \"$orderby\":{\"_id\":-1}}","output":"json","x":360,"y":880,"wires":[["2b757fa3.aedb3"]]},{"id":"e759402f.c58ef","type":"switch","z":"e1a9ea8c.adf12","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":770,"y":880,"wires":[["615ec488.3d0b7c"]]},{"id":"615ec488.3d0b7c","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"time\": { \"$gte\": {{payload.time}} } }","output":"json","x":920,"y":880,"wires":[["a16f137e.c78078"]]},{"id":"a16f137e.c78078","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleData","operation":"find.toArray","x":1140,"y":880,"wires":[["51de5e00.4a28dc"]]},{"id":"fd1b6555.4f30a","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"AngleState","operation":"insertOne","x":2000,"y":880,"wires":[["ffc3af0c.bef96"]]},{"id":"9e34c7ed.4df99","type":"comment","z":"e1a9ea8c.adf12","name":"Close angleState","info":"","x":380,"y":840,"wires":[]},{"id":"6e6c8655.5dd53","type":"function","z":"e1a9ea8c.adf12","name":"","func":"\n\nmsg.goal = msg.payload\nmsg.payload = msg.angleData\n\nvar retObj = {};\nretObj.lessThanZero = 0\nretObj.zeroToFifteen = 0\nretObj.fifteenToThirty = 0\nretObj.thirtyToFourtyfive = 0\nretObj.fourtyfiveAndMore = 0\n\nvar sum = 0;\nvar points = 0;\n\nfor(var i =0; i < msg.payload.length; i++) {\n    if (msg.payload[i].Angle < 0)\n    {\n        retObj.lessThanZero++;\n    }\n    else if (msg.payload[i].Angle >= 0 && msg.payload[i].Angle < 15)\n    {\n        retObj.zeroToFifteen++;\n    }\n    else if (msg.payload[i].Angle >= 15 && msg.payload[i].Angle < 30)\n    {\n        retObj.fifteenToThirty++;\n    }\n    else if (msg.payload[i].Angle >= 30 && msg.payload[i].Angle < 45)\n    {\n        retObj.thirtyToFourtyfive++;\n    }\n    else\n    {\n        retObj.fourtyfiveAndMore++;\n    }\n    sum += msg.payload[i].Angle\n    points++\n}\n\n\nretObj.time = msg.payload[msg.payload.length - 1].time\nretObj.elapsed = msg.payload[msg.payload.length - 1].time - msg.payload[0].time\nretObj.average = Math.round(sum/points)\nretObj.requiredDuration = msg.goal.tiltLength\nretObj.requiredAngle = msg.goal.tiltAngle\nretObj.state = \"Stopped\"\n\n\nmsg.payload = retObj\n\nreturn msg;","outputs":1,"noerr":0,"x":1790,"y":880,"wires":[["fd1b6555.4f30a"]]},{"id":"cb278917.3a5a28","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":1600,"y":880,"wires":[["6e6c8655.5dd53"]]},{"id":"51de5e00.4a28dc","type":"function","z":"e1a9ea8c.adf12","name":"Create Request","func":"msg.angleData = msg.payload\nvar request = [{\"Value\":\"Goal\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":880,"wires":[["cb278917.3a5a28"]]},{"id":"a7c201b4.edfc9","type":"template","z":"8583948d.d27ea","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{date}} -> {{payload}}","output":"str","x":580,"y":160,"wires":[["7ee4cf58.8627"]]},{"id":"69ad52be.f4ac04","type":"function","z":"8583948d.d27ea","name":"","func":"var now = new Date()\nmsg.date = now.toLocaleTimeString() +\" \"+ now.toLocaleDateString();\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":160,"wires":[["a7c201b4.edfc9"]]},{"id":"7ee4cf58.8627","type":"file","z":"8583948d.d27ea","name":"","filename":"/home/pi/MOvIT-Detect-Backend/movit.log","appendNewline":true,"createDir":true,"overwriteFile":"false","x":850,"y":160,"wires":[[]]},{"id":"a43e21f1.be1f3","type":"file in","z":"aa0f77d4.90b038","name":"","filename":"/home/pi/MOvIT-Detect-Backend/movit.log","format":"utf8","chunk":false,"sendError":false,"x":430,"y":200,"wires":[[]]},{"id":"ae4e98ad.b86ca8","type":"http in","z":"d8422fcd.8b4f88","name":"","url":"/log","method":"get","upload":false,"swaggerDoc":"","x":320,"y":1000,"wires":[["49059628.05be48"]]},{"id":"d601d5f5.e4447","type":"http response","z":"d8422fcd.8b4f88","name":"","statusCode":"","headers":{},"x":810,"y":1000,"wires":[]},{"id":"49059628.05be48","type":"subflow:aa0f77d4.90b038","z":"d8422fcd.8b4f88","name":"","x":490,"y":1000,"wires":[["1bca5b67.00cbb5"]]},{"id":"1bca5b67.00cbb5","type":"function","z":"d8422fcd.8b4f88","name":"\\n -> <br>","func":"msg.payload = \"<h1>Log file</h1>\" + msg.payload.replace(/\\n/g, \"<br>\")\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":1000,"wires":[["d601d5f5.e4447"]]},{"id":"ef14dcde.25237","type":"subflow:8583948d.d27ea","z":"85ae1227.5aacf8","name":"","x":1990,"y":1160,"wires":[[]]},{"id":"ace5e1c5.f15e2","type":"subflow:8583948d.d27ea","z":"85ae1227.5aacf8","name":"","x":3350,"y":1280,"wires":[[]]},{"id":"2da93967.40576e","type":"subflow:8583948d.d27ea","z":"85ae1227.5aacf8","name":"","x":3130,"y":1060,"wires":[[]]},{"id":"16081418.b3579c","type":"subflow:8583948d.d27ea","z":"85ae1227.5aacf8","name":"","x":4710,"y":1140,"wires":[[]]},{"id":"7ba5c45e.b81e74","type":"subflow:8583948d.d27ea","z":"85ae1227.5aacf8","name":"","x":550,"y":1160,"wires":[[]]},{"id":"832f94e.0c0f4e8","type":"subflow:8583948d.d27ea","z":"e1a9ea8c.adf12","name":"","x":510,"y":620,"wires":[[]]},{"id":"42a51204.fdc3a4","type":"subflow:8583948d.d27ea","z":"e1a9ea8c.adf12","name":"","x":1970,"y":720,"wires":[[]]},{"id":"dc6de87.05ba498","type":"subflow:8583948d.d27ea","z":"e1a9ea8c.adf12","name":"","x":1990,"y":800,"wires":[[]]},{"id":"c965574c.2f3a88","type":"subflow:8583948d.d27ea","z":"e1a9ea8c.adf12","name":"","x":2370,"y":880,"wires":[[]]},{"id":"1ec6a8fc.b5268f","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Closing SeatingState","output":"str","x":1840,"y":800,"wires":[["dc6de87.05ba498"]]},{"id":"ffc3af0c.bef96","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Closing AngleState","output":"str","x":2220,"y":880,"wires":[["c965574c.2f3a88"]]},{"id":"3e7d4c9b.4e1a7c","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelState","operation":"findOne","x":580,"y":720,"wires":[["1734117d.05d697"]]},{"id":"8b81bb81.704998","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"$query\":{}, \"$orderby\":{\"_id\":-1}}","output":"json","x":360,"y":720,"wires":[["3e7d4c9b.4e1a7c"]]},{"id":"1734117d.05d697","type":"switch","z":"e1a9ea8c.adf12","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"Started","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":790,"y":720,"wires":[["cdec5e10.b79f68"]]},{"id":"cdec5e10.b79f68","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"time\": { \"$gte\": {{payload.time}} } }","output":"json","x":940,"y":720,"wires":[["6152a1b9.133098"]]},{"id":"6152a1b9.133098","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelData","operation":"find.toArray","x":1170,"y":720,"wires":[["8bfbe6a1.4a4f18"]]},{"id":"8bfbe6a1.4a4f18","type":"function","z":"e1a9ea8c.adf12","name":"","func":"var retObj = {};\n\nretObj.time = msg.payload[msg.payload.length - 1].time\nretObj.elapsed = msg.payload[msg.payload.length - 1].time - msg.payload[0].time\nretObj.state = \"Stopped\"\n\nmsg.payload = retObj\n\nreturn msg;","outputs":1,"noerr":0,"x":1390,"y":720,"wires":[["9d25304.e8c3c5"]]},{"id":"9d25304.e8c3c5","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelState","operation":"insertOne","x":1600,"y":720,"wires":[["fba942a5.2bb968"]]},{"id":"ce058ff1.52689","type":"comment","z":"e1a9ea8c.adf12","name":"Close travelState","info":"","x":380,"y":680,"wires":[]},{"id":"fba942a5.2bb968","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Closing TravelState","output":"str","x":1820,"y":720,"wires":[["42a51204.fdc3a4"]]},{"id":"3aff458c.71898a","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"NotificationState","operation":"findOne","x":590,"y":980,"wires":[["6ab702cf.962564"]]},{"id":"77b13227.b3f2ac","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"$query\":{}, \"$orderby\":{\"_id\":-1}}","output":"json","x":360,"y":980,"wires":[["3aff458c.71898a"]]},{"id":"6ab702cf.962564","type":"switch","z":"e1a9ea8c.adf12","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"neq","v":"NOTIFICATION_COMPLETE","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":980,"wires":[["faa96adf.37eb2"]]},{"id":"7adba00b.aab3a","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"NotificationState","operation":"insertOne","x":1180,"y":980,"wires":[["4e0c8817.b4d99"]]},{"id":"efefacf7.58eb98","type":"comment","z":"e1a9ea8c.adf12","name":"Close notificationState","info":"","x":400,"y":940,"wires":[]},{"id":"4e0c8817.b4d99","type":"template","z":"e1a9ea8c.adf12","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Closing NotificationState","output":"str","x":1420,"y":980,"wires":[["441e6c99.7e25bc"]]},{"id":"7aa6f02f.0d9f08","type":"is online","z":"fd561dd2.b6ea58","name":"","url":"","action":"0","x":500,"y":960,"wires":[["c5735bb0.7cf59"]]},{"id":"c5735bb0.7cf59","type":"debug","z":"fd561dd2.b6ea58","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":670,"y":960,"wires":[]},{"id":"23329f23.6a3b4","type":"inject","z":"fd561dd2.b6ea58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":960,"wires":[["7aa6f02f.0d9f08"]]},{"id":"faa96adf.37eb2","type":"function","z":"e1a9ea8c.adf12","name":"","func":"msg.payload.time++\nmsg.payload.elapsed++\nmsg.payload.state = \"NOTIFICATION_COMPLETE\"\ndelete msg.payload._id\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":980,"wires":[["7adba00b.aab3a"]]},{"id":"441e6c99.7e25bc","type":"subflow:8583948d.d27ea","z":"e1a9ea8c.adf12","name":"","x":1570,"y":980,"wires":[[]]},{"id":"17de233e.684625","type":"mongodb2 in","z":"fd561dd2.b6ea58","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Update Configuration","collection":"Config","operation":"findOne","x":1400,"y":380,"wires":[["a5d549ca.280e9"]]},{"id":"f28389a8.19023","type":"function","z":"fd561dd2.b6ea58","name":"Create Request","func":"msg.payload =[{Value:\"Alarm\"},{}];\nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":380,"wires":[["17de233e.684625"]]},{"id":"5a161d7f.bdf054","type":"mqtt out","z":"fd561dd2.b6ea58","name":"","topic":"config/notifications_settings","qos":"","retain":"","broker":"2b8661c7.194ede","x":1820,"y":380,"wires":[]},{"id":"d8ae7fec.352b28","type":"mongodb2 in","z":"e1a9ea8c.adf12","service":"_ext_","configNode":"c2e023a5.ad0b","name":"Retreive Configuration","collection":"Config","operation":"findOne","x":600,"y":420,"wires":[["7ee55b94.e5bc5c"]]},{"id":"4fc81347.8e4834","type":"function","z":"e1a9ea8c.adf12","name":"Create Request","func":"msg.payload = {\"Value\":\"Alarm\"};\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":420,"wires":[["d8ae7fec.352b28"]]},{"id":"7ee55b94.e5bc5c","type":"function","z":"e1a9ea8c.adf12","name":"Format data","func":"msg.payload = (msg.payload.isLedBlinkingEnabled ? 1 : 0)+\":\"+(msg.payload.isVibrationEnabled ? 1 : 0)+\":\"+msg.payload.snoozeTime+\":\"+(msg.payload.enabled ? 1 : 0)\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":420,"wires":[["8ad43f6e.4b0ee"]]},{"id":"8ad43f6e.4b0ee","type":"mqtt out","z":"e1a9ea8c.adf12","name":"","topic":"config/notifications_settings","qos":"","retain":"","broker":"2b8661c7.194ede","x":1040,"y":420,"wires":[]},{"id":"a5d549ca.280e9","type":"function","z":"fd561dd2.b6ea58","name":"Format data","func":"msg.payload = (msg.payload.isLedBlinkingEnabled ? 1 : 0)+\":\"+(msg.payload.isVibrationEnabled ? 1 : 0)+\":\"+msg.payload.snoozeTime+\":\"+(msg.payload.enabled ? 1 : 0)\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":380,"wires":[["5a161d7f.bdf054"]]},{"id":"ea694b67.6e7a88","type":"comment","z":"785b00cb.55902","name":"[seating, travel]","info":"","x":2020,"y":1100,"wires":[]},{"id":"2daf328b.9dec36","type":"function","z":"785b00cb.55902","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day));\nmsg.start = Math.ceil((date.getTime() + msg.payload.Offset*3600000)/1000);\nmsg.end = ((msg.start + 3600*24 - 1))\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":1053,"wires":[["c8cbd01c.2ca0b"]]},{"id":"feffc1f7.8c3f48","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelData","operation":"find.toArray","x":1510,"y":1080,"wires":[["1806fcd2.89a03b"]]},{"id":"84c04c10.62fae8","type":"function","z":"785b00cb.55902","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1270,"y":1053,"wires":[["feffc1f7.8c3f48","1731c1ac.fccc76"]]},{"id":"1806fcd2.89a03b","type":"function","z":"785b00cb.55902","name":"","func":"var timeAboveAngle = 0;\n\nvar requiredAngle = msg.reduceSlidingMoving;\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    if(msg.payload[i].seatAngle >= requiredAngle) {\n        timeAboveAngle++;\n    }\n}\n\nmsg.topic = \"travelPercent\"\nmsg.payload = timeAboveAngle/msg.payload.length\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1080,"wires":[["27d5570f.6db68"]]},{"id":"b7779fed.928408","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":890,"y":1053,"wires":[["8e554f5.9f5503"]]},{"id":"c8cbd01c.2ca0b","type":"function","z":"785b00cb.55902","name":"","func":"var request = [{\"Value\":\"Recommandation\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":1053,"wires":[["b7779fed.928408"]]},{"id":"8e554f5.9f5503","type":"change","z":"785b00cb.55902","name":"","rules":[{"t":"set","p":"reduceSlidingMoving","pt":"msg","to":"payload.reduceSlidingMoving","tot":"msg"},{"t":"set","p":"reduceSlidingRest","pt":"msg","to":"payload.reduceSlidingRest","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":1053,"wires":[["84c04c10.62fae8"]]},{"id":"1731c1ac.fccc76","type":"mongodb2 in","z":"785b00cb.55902","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"find.toArray","x":1510,"y":1020,"wires":[["a627f2ea.0f49b8"]]},{"id":"a627f2ea.0f49b8","type":"function","z":"785b00cb.55902","name":"","func":"var timeAboveAngle = 0;\n\nvar requiredAngle = msg.reduceSlidingRest;\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    if(msg.payload[i].angle >= requiredAngle) {\n        timeAboveAngle++;\n    }\n}\nmsg.topic = \"restPercent\"\nmsg.payload = timeAboveAngle/msg.payload.length\n\nreturn msg;","outputs":1,"noerr":0,"x":1730,"y":1020,"wires":[["27d5570f.6db68"]]},{"id":"27d5570f.6db68","type":"join","z":"785b00cb.55902","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1870,"y":1040,"wires":[["674e3763.25588"]]},{"id":"ffd0233b.eca14","type":"comment","z":"dc840522.071f9","name":"[seating, travel]","info":"","x":1980,"y":400,"wires":[]},{"id":"717d7362.6b40ac","type":"function","z":"dc840522.071f9","name":"Datestamp for whole day","func":"var date = new Date(parseInt(msg.payload.Day));\nmsg.start = Math.ceil((date.getTime() + msg.payload.Offset*3600000)/1000);\nmsg.end = ((msg.start + 3600*24 - 1))\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":580,"wires":[["fb16d6ac.fe0af8"]]},{"id":"cfc022e1.f6ee","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"TravelData","operation":"find.toArray","x":1410,"y":600,"wires":[["2d1cb27d.c3230e"]]},{"id":"8a1d2a6a.45fd7","type":"function","z":"dc840522.071f9","name":"EventToQuery","func":"msg.payload = { 'time' : { '$gte' : msg.start , '$lte' : msg.end } };\nreturn msg","outputs":1,"noerr":0,"x":1180,"y":580,"wires":[["cfc022e1.f6ee","af424ea1.e53af"]]},{"id":"2d1cb27d.c3230e","type":"function","z":"dc840522.071f9","name":"","func":"var timeAboveAngle = 0;\n\nvar requiredAngle = msg.reduceSlidingMoving;\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    if(msg.payload[i].seatAngle >= requiredAngle) {\n        timeAboveAngle++;\n    }\n}\n\nmsg.topic = \"travelPercent\"\nmsg.payload = timeAboveAngle/msg.payload.length\n\nif (isNaN(msg.payload)) {\n    msg.payload = 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":600,"wires":[["c801379e.0e2b8"]]},{"id":"e96b07e6.3e86a8","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"find one","collection":"Config","operation":"findOne","x":840,"y":580,"wires":[["1e1d90c.f1222ef"]]},{"id":"fb16d6ac.fe0af8","type":"function","z":"dc840522.071f9","name":"","func":"var request = [{\"Value\":\"Recommandation\"}];\nmsg.payload= request;\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":580,"wires":[["e96b07e6.3e86a8"]]},{"id":"1e1d90c.f1222ef","type":"change","z":"dc840522.071f9","name":"","rules":[{"t":"set","p":"reduceSlidingMoving","pt":"msg","to":"payload.reduceSlidingMoving","tot":"msg"},{"t":"set","p":"reduceSlidingRest","pt":"msg","to":"payload.reduceSlidingRest","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":580,"wires":[["8a1d2a6a.45fd7"]]},{"id":"af424ea1.e53af","type":"mongodb2 in","z":"dc840522.071f9","service":"_ext_","configNode":"c2e023a5.ad0b","name":"","collection":"SeatingData","operation":"find.toArray","x":1410,"y":560,"wires":[["4667d6b8.102d08"]]},{"id":"4667d6b8.102d08","type":"function","z":"dc840522.071f9","name":"","func":"var timeAboveAngle = 0;\n\nvar requiredAngle = msg.reduceSlidingRest;\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    if(msg.payload[i].angle >= requiredAngle) {\n        timeAboveAngle++;\n    }\n}\nmsg.topic = \"restPercent\"\nmsg.payload = timeAboveAngle/msg.payload.length\n\nif (isNaN(msg.payload)) {\n    msg.payload = 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1610,"y":560,"wires":[["c801379e.0e2b8"]]},{"id":"c801379e.0e2b8","type":"join","z":"dc840522.071f9","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1730,"y":580,"wires":[["2f80af88.cbc25"]]},{"id":"d2ffe9bc.248dd","type":"debug","z":"85ae1227.5aacf8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":4170,"y":1160,"wires":[]},{"id":"e2a1a59e.560e38","type":"function","z":"85ae1227.5aacf8","name":"","func":"msg.payload = msg.payload.filedata\nreturn msg;","outputs":1,"noerr":0,"x":3870,"y":1160,"wires":[["cc089fd5.3b7368"]]},{"id":"cc089fd5.3b7368","type":"json","z":"85ae1227.5aacf8","name":"","property":"payload","action":"","pretty":true,"x":4010,"y":1160,"wires":[["d2ffe9bc.248dd"]]}]